<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BusTracker - –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –∞–≤—Ç–æ–±—É—Å–æ–≤</title>
    <style>
        /* –û–±—â–∏–µ —Å—Ç–∏–ª–∏ */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Arial', sans-serif;
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
            padding: 20px;
        }
        
        /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã */
        .container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            margin-bottom: 20px;
        }
        
        /* –û—Ç—Å—Ç—É–ø—ã –¥–ª—è –≤—Å–µ—Ö–ª–∞–¥–æ–∫ */
        .app-content, .welcome-screen, .admin-login,
        .bus-window > .container, .stop-window {
            padding: 15px;
        }
        
        /* –≠–∫—Ä–∞–Ω –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è */
        .welcome-screen {
            text-align: center;
        }
        
        .welcome-title {
            font-size: 24px;
            margin-bottom: 15px;
            color: #2c3e50;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .welcome-title img {
            width: 30px;
            height: 30px;
            margin-right: 10px;
        }
        
        .mode-select {
            margin-top: 20px;
        }
        
        .mode-btn {
            display: block;
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .admin-btn {
            background-color: #3498db;
            color: white;
        }
        
        .user-btn {
            background-color: #2ecc71;
            color: white;
        }
        
        .mode-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        /* –§–æ—Ä–º–∞ –≤—Ö–æ–¥–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ */
        .admin-login {
            display: none;
            margin-top: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .admin-login input {
            width: 100%;
            padding: 12px;
            margin-bottom: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border 0.3s;
        }
        
        .admin-login input:focus {
            border-color: #3498db;
            outline: none;
        }
        
        .error-msg {
            color: #e74c3c;
            margin: 10px 0;
            display: none;
            font-size: 14px;
        }
        
        /* –û—Å–Ω–æ–≤–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ */
        .app-header {
            padding: 15px;
            background: #3498db;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .app-title {
            font-size: 18px;
            font-weight: bold;
            display: flex;
            align-items: center;
        }
        
        .app-title img {
            width: 25px;
            height: 25px;
            margin-right: 8px;
        }
        
        .user-badge {
            background: rgba(255, 255, 255, 0.2);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
        }
        
        .app-content {
            padding: 15px;
        }
        
        /* –ü–∞–Ω–µ–ª—å –ø–æ–∏—Å–∫–∞ */
        .search-container {
            margin-bottom: 12px;
            position: relative;
            display: flex;
            width: 100%;
        }
        
        .search-input-container {
            flex-grow: 1;
            position: relative;
            min-width: 0;
        }
        
        .search-input {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px 0 0 8px;
            font-size: 14px;
            box-sizing: border-box;
        }
        
        .search-button {
            padding: 0 15px;
            background: #2ecc71;
            color: white;
            border: none;
            border-radius: 0 8px 8px 0;
            cursor: pointer;
            font-size: 14px;
            white-space: nowrap;
        }
        
        .search-results {
            position: absolute;
            background: white;
            width: 100%;
            border: 1px solid #ddd;
            border-radius: 0 0 5px 5px;
            z-index: 100;
            display: none;
            top: 100%;
            left: 0;
            margin-top: -2px;
            max-height: 200px;
            overflow-y: auto;
            font-size: 14px;
        }
        
        .search-item {
            padding: 8px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
            display: flex;
            align-items: center;
        }
        
        .search-item:hover {
            background-color: #f5f5f5;
        }
        
        .not-found {
            padding: 8px;
            color: #666;
            text-align: center;
            font-size: 14px;
        }
        
        /* –°–ø–∏—Å–æ–∫ –∞–≤—Ç–æ–±—É—Å–æ–≤ */
        .bus-list {
            margin-top: 15px;
        }
        
        .bus-item {
            background: white;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 12px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }
        
        .bus-header {
            display: flex;
            flex-direction: column;
            margin-bottom: 8px;
        }
        
        .bus-number-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .bus-number {
            font-size: 16px;
            font-weight: bold;
            color: #2c3e50;
            display: flex;
            align-items: center;
        }
        
        .bus-number img {
            width: 18px;
            height: 18px;
            margin-right: 6px;
        }
        
        .bus-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }
        
        .action-btn {
            padding: 6px 10px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }
        
        .action-btn:hover {
            background: #2980b9;
            transform: translateY(-1px);
        }
        
        .admin-action {
            background: #2ecc71;
        }
        
        .admin-action:hover {
            background: #27ae60;
        }
        
        .danger-action {
            background: #e74c3c;
        }
        
        .danger-action:hover {
            background: #c0392b;
        }
        
        /* –û–∫–Ω–∞ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π */
        .bus-window, .stop-window {
            width: 100%;
            margin-top: 10px;
            display: none;
        }
        
        .stop-info {
            padding: 8px;
            background: #eee;
            border-radius: 5px;
            margin-top: 5px;
            font-size: 14px;
        }
        
        .highlight {
            color: limegreen;
            font-size: 16px;
        }
        
        /* –ö–∞—Ä—Ç–∞ –º–∞—Ä—à—Ä—É—Ç–∞ */
        .route-map {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            position: relative;
            margin-left: 15px;
        }
        
        .route-map .stop {
            display: flex;
            flex-direction: column;
            margin: 0;
            width: 100%;
            position: relative;
            padding-bottom: 25px;
        }
        
        .route-map .stop:last-child {
            padding-bottom: 0;
        }
        
        .route-map .stop .stop-header {
            display: flex;
            align-items: center;
            width: 100%;
            padding: 8px;
            background: #f9f9f9;
            border-radius: 5px;
            margin-bottom: 2px;
            cursor: pointer;
            position: relative;
            z-index: 2;
            font-size: 14px;
        }
        
        .route-map .stop .circle {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #000;
            margin-right: 8px;
            position: relative;
            z-index: 2;
        }
        
        .route-map .stop .arrow-right {
            font-size: 14px;
            color: #666;
            margin-left: auto;
        }
        
        .stop-title {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 8px;
        }
        
        .transport-list {
            margin-top: 12px;
        }
        
        .transport-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            padding: 8px;
            background: #f9f9f9;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .bus-icon {
            font-size: 16px;
            margin-right: 8px;
        }
        
        .bus-number {
            font-weight: bold;
            margin-right: 12px;
            min-width: 25px;
        }
        
        .bus-time {
            display: flex;
            align-items: center;
            color: limegreen;
            margin-left: auto;
            font-size: 14px;
        }
        
        .time-circle {
            width: 6px;
            height: 6px;
            background-color: limegreen;
            border-radius: 50%;
            margin-right: 4px;
        }
        
        .action-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
            flex-wrap: wrap;
            gap: 5px;
        }
        
        .action-button {
            padding: 6px 12px;
            background: #f0f0f0;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            flex-grow: 1;
            text-align: center;
        }
        
        .stop-content {
            display: flex;
            align-items: center;
            width: 100%;
        }
        
        .boarding-status {
            background-color: #4CAF50;
            color: white;
            padding: 2px 6px;
            border-radius: 12px;
            font-size: 11px;
            margin-left: 8px;
            border: 1px solid #2d7d32;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            white-space: nowrap;
        }
        
        .arriving-status {
            color: limegreen;
            font-size: 16px;
        }
        
        .bus-list-item {
            position: relative;
        }
        
        /* –ö–Ω–æ–ø–∫–∞ —Å–º–µ–Ω—ã —Ä–µ–∂–∏–º–∞ */
        .mode-switch-btn {
            position: fixed;
            bottom: 15px;
            right: 15px;
            padding: 10px 15px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 30px;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            z-index: 100;
            transition: all 0.3s;
            font-size: 14px;
        }
        .mode-switch-btn:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }
        
        /* –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ */
        .add-stop-container {
            margin-top: 8px;
        }
        
        .add-stop-container input {
            width: 100%;
            padding: 8px;
            margin: 4px 0;
            border: 1px solid #ddd;
            border-radius: 5px;
            box-sizing: border-box;
            font-size: 14px;
        }
        
        .bold {
            font-weight: bold;
        }
        
        .arriving {
            color: limegreen;
            font-weight: bold;
        }
        
        .hidden {
            display: none;
        }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è */
        .stop-item {
            padding: 8px;
            background: #f9f9f9;
            margin: 4px 0;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .stop-name {
            margin-bottom: 4px;
        }
        
        .next-stop {
            font-weight: bold;
            color: #2c3e50;
        }
        
        /* –§–æ—Ä–º–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ */
        .edit-stop-form {
            margin-top: 12px;
            padding: 12px;
            background: #f5f5f5;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .edit-stop-form input {
            width: 100%;
            padding: 6px;
            margin: 4px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .edit-stop-actions {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
            gap: 5px;
        }
        
        /* –°—Ç–∞—Ç—É—Å—ã */
        .status {
            font-weight: bold;
            margin-left: 8px;
            font-size: 14px;
        }
        
        .status.offline {
            color: #e74c3c;
        }
        
        .status.on-the-way {
            color: #f39c12;
        }
        
        .status.boarding {
            color: #2ecc71;
        }
        
        /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∫–∞—Ä—Ç—ã */
        #mapContainer {
            width: 100%;
            height: 300px;
            display: none;
            margin-bottom: 15px;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #ddd;
            position: relative;
        }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è –≤—Å—Ç—Ä–æ–µ–Ω–Ω–æ–π –∫–∞—Ä—Ç—ã */
        .google-map-container {
            width: 100%;
            height: 100%;
            border: none;
        }
        
        /* –ö–Ω–æ–ø–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è –∫–∞—Ä—Ç—ã ‚Äî —Å–¥–≤–∏–Ω—É—Ç–∞ –≤–ª–µ–≤–æ –æ—Ç –≤—Å—Ç—Ä–æ–µ–Ω–Ω–æ–≥–æ –º–µ–Ω—é –∫–∞—Ä—Ç—ã */
        .close-map-btn {
            position: absolute;
            top: 15px;
            right: 50px;
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            font-size: 16px;
            cursor: pointer;
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        .close-map-btn:hover {
            background: #c0392b;
        }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–Ω–æ–ø–∫–∏ GPS */
        .gps-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }
        
        /* –ù–æ–≤—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –∫–∞–ª–µ–Ω–¥–∞—Ä–∏–∫–∞ –∏ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è */
        .calendar-icon {
            width: 16px;
            height: 16px;
            margin-left: 8px;
            cursor: pointer;
        }
        
        .full-schedule-container {
            display: none;
            margin-top: 10px;
            padding: 10px;
            background: #f5f5f5;
            border-radius: 5px;
        }
        
        .hour-block {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
            padding-bottom: 10px;
            border-bottom: 1px solid #ddd;
        }
        
        .hour-block:last-child {
            border-bottom: none;
            padding-bottom: 0;
        }
        
        .hour-label {
            background-color: #3498db;
            color: white;
            padding: 3px 8px;
            border-radius: 5px;
            margin-right: 10px;
            font-weight: bold;
            min-width: 40px;
            text-align: center;
        }
        
        .minutes-list {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }
        
        .minute-item {
            padding: 3px 8px;
            border-radius: 50%;
            position: relative;
        }
        
        .current-minute {
            background-color: #3498db;
            color: white;
            font-weight: bold;
        }
        
        /* –ù–æ–≤—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –æ–∫–Ω–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ */
        .stop-info-window {
            margin-top: 15px;
            background: white;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .stop-info-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .stop-info-subtitle {
            color: #777;
            font-size: 12px;
            margin-bottom: 15px;
        }
        
        .bus-numbers-list {
            color: #a2c93a;
            font-size: 14px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .bus-time-container {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            overflow-x: auto;
            padding-bottom: 10px;
            scrollbar-width: thin;
            scrollbar-color: #a2c93a #f0f0f0;
        }
        
        .bus-time-container::-webkit-scrollbar {
            height: 6px;
        }
        
        .bus-time-container::-webkit-scrollbar-track {
            background: #f0f0f0;
            border-radius: 3px;
        }
        
        .bus-time-container::-webkit-scrollbar-thumb {
            background-color: #a2c93a;
            border-radius: 3px;
        }
        
        .bus-time-item {
            background-color: #a2c93a;
            padding: 0px 0px;
            border-radius: 20px;
            color: white;
            text-align: center;
            min-width: 80px;
            flex-shrink: 0;
        }
        
        .bus-time-number {
            font-weight: bold;
            font-size:14px ;
            display: flex;
            align-items: center;
            margin-top: 1px;
            padding-right: 8px;
        }
        
        .bus-time-arrival {
            color: #3ac94b;
            display: flex;
            align-items: center;
            gap: 5px;
            margin-left: 1px;
            margin-top: -7px;
            font-size: 10px;
        }
        
        .bus-time-dot {
            width: 5px;
            height: 5px;
            background-color: #3ac94b;
            border-radius: 50%;
            display: inline-block;
            margin-left: 3px;
        }
        
        .arriving-text {
            color: #3ac94b;
            font-weight: bold;
        }

        .bus-time-block {
          display: flex;
          flex-direction: column;
          align-items: flex-start;
          margin-bottom: 10px;
        }
        
        /* –ú–µ–¥–∏–∞-–∑–∞–ø—Ä–æ—Å—ã –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ */
        @media (max-width: 480px) {
            .container {
                border-radius: 8px;
            }
            
            .app-content, .welcome-screen, .admin-login,
            .bus-window > .container, .stop-window {
                padding: 12px;
            }
            
            .welcome-title {
                font-size: 20px;
            }
            
            .mode-btn {
                padding: 10px;
                font-size: 14px;
            }
            
            .app-title {
                font-size: 16px;
            }
            
            .bus-actions {
                gap: 4px;
            }
            
            .action-btn {
                padding: 5px 8px;
                font-size: 11px;
            }
            
            .route-map .stop .stop-header {
                padding: 6px;
                font-size: 13px;
            }
            
            .stop-title {
                font-size: 15px;
            }
            
            .transport-item {
                font-size: 13px;
                padding: 6px;
            }
            
            .action-buttons {
                gap: 4px;
            }
            
            .action-button {
                padding: 5px 8px;
                font-size: 11px;
            }
            
            .full-schedule-title {
                font-size: 16px;
                white-space: normal;
                word-break: break-word;
            }
            
            .stop-info-title {
                font-size: 16px;
            }
            
            .stop-info-subtitle {
                font-size: 14px;
            }
            
            .bus-numbers-list {
                font-size: 12px;
            }
            
            .bus-time-item {
                min-width: 54px;
            }
        }
    </style>
</head>
<body>
    <!-- –≠–∫—Ä–∞–Ω –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è -->
    <div class="container welcome-screen" id="welcomeScreen">
        <h1 class="welcome-title"><img src="https://cdn2.iconfinder.com/data/icons/travel-set-2/512/18-1024.png" alt="Bus">BusTracker</h1>
        <p>–°–∏—Å—Ç–µ–º–∞ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∞–≤—Ç–æ–±—É—Å–æ–≤</p>
        
        <div class="mode-select">
            <button class="mode-btn admin-btn" id="adminModeBtn">
                üëì –†–µ–∂–∏–º –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
            </button>
            <button class="mode-btn user-btn" id="userModeBtn">
                üë§ –†–µ–∂–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            </button>
        </div>
        
        <div class="admin-login" id="adminLogin">
            <input type="password" id="adminPassword" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞">
            <p class="error-msg" id="errorMsg">–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å!</p>
            <button class="mode-btn admin-btn" id="loginBtn">–í–æ–π—Ç–∏</button>
        </div>
    </div>
    
    <!-- –û—Å–Ω–æ–≤–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ -->
    <div class="container app-container hidden" id="appContainer">
        <div class="app-header">
            <div class="app-title"><img src="https://cdn2.iconfinder.com/data/icons/travel-set-2/512/18-1024.png" alt="Bus">BusTracker</div>
            <div class="user-badge" id="userBadge">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</div>
        </div>
        
        <div class="app-content">
            <div class="search-container">
                <div class="search-input-container">
                    <input id="searchInput" class="search-input" type="text" placeholder="–ü–æ–∏—Å–∫ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –∏–ª–∏ –Ω–æ–º–µ—Ä–∞ –∞–≤—Ç–æ–±—É—Å–∞">
                    <div id="searchResults" class="search-results"></div>
                </div>
                <button class="search-button" id="searchBtn">–ù–∞–π—Ç–∏</button>
            </div>
            
            <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∫–∞—Ä—Ç—ã -->
            <div id="mapContainer">
                <button class="close-map-btn" onclick="closeMap()">√ó</button>
                <iframe class="google-map-container" src="https://www.google.com/maps/d/u/0/embed?mid=1Hkdu4NCMJT7F6vjyQJ7cXEsxMuARRhU&ehbc=2E312F&hl=ru&ui=0&zoom=1"></iframe>
            </div>
            
            <!-- –ö–Ω–æ–ø–∫–∞ –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è —Å–ø–∏—Å–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–æ–∫ -->
            <button class="mode-btn" id="showStopsBtn" style="margin-top: 10px; background-color: #9b59b6; color: white;">–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏
                
            </button>
            
            <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Å–ø–∏—Å–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–æ–∫ -->
            <div id="stopsListContainer" class="hidden" style="margin-top: 15px;">
                <div id="stopsList" class="bus-list"></div>
            </div>
            
            <div id="stopInfoContainer">
                <div id="stopInfoWindow" class="stop-window"></div>
            </div>
            
            <div id="adminPanel" class="hidden">
                <input id="busNumber" type="text" placeholder="–ù–æ–º–µ—Ä –∞–≤—Ç–æ–±—É—Å–∞" class="add-stop-container">
                <button class="action-btn admin-action" id="addBusBtn">‚ûï –î–æ–±–∞–≤–∏—Ç—å –∞–≤—Ç–æ–±—É—Å</button>
            </div>
            
            <h3><img src="https://oskemenbus.kz/assets/images/ui-elements/vehicle-icons/single_bus.svg" width="20" height="20" style="margin-right: 6px; position: relative; top: 3px;">–ê–≤—Ç–æ–±—É—Å—ã</h3>
            <div id="busList" class="bus-list"></div>
        </div>
    </div>
    
    <button class="mode-switch-btn hidden" id="modeSwitchBtn">–°–º–µ–Ω–∏—Ç—å —Ä–µ–∂–∏–º</button>

    <script>
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let buses = JSON.parse(localStorage.getItem("buses")) || {};
        let currentStop = localStorage.getItem("currentStop") || null;
        let updateInterval;
        let isAdminMode = false;
        const ADMIN_PASSWORD = "123654789"; // –ü–∞—Ä–æ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
        let busMarkers = {}; // –î–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –º–∞—Ä–∫–µ—Ä–æ–≤ –∞–≤—Ç–æ–±—É—Å–æ–≤
        let busPositions = {}; // –î–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç–µ–∫—É—â–∏—Ö –ø–æ–∑–∏—Ü–∏–π –∞–≤—Ç–æ–±—É—Å–æ–≤
        
        // DOM —ç–ª–µ–º–µ–Ω—Ç—ã
        const welcomeScreen = document.getElementById('welcomeScreen');
        const appContainer = document.getElementById('appContainer');
        const adminModeBtn = document.getElementById('adminModeBtn');
        const userModeBtn = document.getElementById('userModeBtn');
        const adminLogin = document.getElementById('adminLogin');
        const adminPassword = document.getElementById('adminPassword');
        const errorMsg = document.getElementById('errorMsg');
        const loginBtn = document.getElementById('loginBtn');
        const userBadge = document.getElementById('userBadge');
        const adminPanel = document.getElementById('adminPanel');
        const searchInput = document.getElementById('searchInput');
        const searchResults = document.getElementById('searchResults');
        const searchBtn = document.getElementById('searchBtn');
        const busNumberInput = document.getElementById('busNumber');
        const addBusBtn = document.getElementById('addBusBtn');
        const busList = document.getElementById('busList');
        const stopInfoWindow = document.getElementById('stopInfoWindow');
        const modeSwitchBtn = document.getElementById('modeSwitchBtn');
        const mapContainer = document.getElementById('mapContainer');
        const showStopsBtn = document.getElementById('showStopsBtn');
        const stopsListContainer = document.getElementById('stopsListContainer');
        const stopsList = document.getElementById('stopsList');
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        document.addEventListener('DOMContentLoaded', function() {
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –¥–ª—è —ç–∫—Ä–∞–Ω–∞ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è
            adminModeBtn.addEventListener('click', showAdminLogin);
            userModeBtn.addEventListener('click', startUserMode);
            loginBtn.addEventListener('click', checkAdminPassword);
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
            searchBtn.addEventListener('click', performSearch);
            searchInput.addEventListener('input', handleSearchInput);
            addBusBtn.addEventListener('click', addBus);
            modeSwitchBtn.addEventListener('click', switchMode);
            showStopsBtn.addEventListener('click', toggleStopsList);
            
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
            if (localStorage.getItem('appState') === 'active') {
                const mode = localStorage.getItem('mode') || 'user';
                if (mode === 'admin') {
                    startAdminMode();
                } else {
                    startUserMode();
                }
            }
            
            // –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É
            setInterval(function() {
                if (appContainer.classList.contains('hidden')) return;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –Ω—É–∂–Ω—ã–µ —á–∞—Å—Ç–∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
                if (currentStop) {
                    showStopInfo(currentStop, true);
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –º–∞—Ä–∫–µ—Ä—ã –≤—Å–µ—Ö –∞–≤—Ç–æ–±—É—Å–æ–≤
                for (let busNumber in buses) {
                    updateBusMarkerPosition(busNumber);
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–∫—Ä—ã—Ç—ã–µ –æ–∫–Ω–∞
                    let busWindow = document.getElementById(`bus-window-${busNumber}`);
                    if (busWindow && busWindow.style.display === 'block') {
                        if (busWindow.innerHTML.includes("–°—Ö–µ–º–∞ –º–∞—Ä—à—Ä—É—Ç–∞")) {
                            showRouteMap(busNumber);
                        } else if (busWindow.innerHTML.includes("–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ")) {
                            showSchedule(busNumber);
                        } else if (busWindow.innerHTML.includes("–ü–æ–ª–Ω–æ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ")) {
                            showFullSchedule(busNumber);
                        }
                    }
                }
            }, 15000); // 15 —Å–µ–∫—É–Ω–¥ 
        });
        
        // –§—É–Ω–∫—Ü–∏–∏ —ç–∫—Ä–∞–Ω–∞ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è
        function showAdminLogin() {
            adminLogin.style.display = 'block';
            adminModeBtn.style.display = 'none';
            userModeBtn.style.display = 'none';
        }
        
        function checkAdminPassword() {
            if (adminPassword.value === ADMIN_PASSWORD) {
                startAdminMode();
            } else {
                errorMsg.style.display = 'block';
            }
        }
        
        function startAdminMode() {
            isAdminMode = true;
            userBadge.textContent = '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä';
            adminPanel.classList.remove('hidden');
            initializeApp();
        }
        
        function startUserMode() {
            isAdminMode = false;
            userBadge.textContent = '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
            adminPanel.classList.add('hidden');
            initializeApp();
        }
        
        function initializeApp() {
            welcomeScreen.style.display = 'none';
            appContainer.classList.remove('hidden');
            modeSwitchBtn.classList.remove('hidden');
            
            localStorage.setItem('appState', 'active');
            localStorage.setItem('mode', isAdminMode ? 'admin' : 'user');
            
            renderBusList();
            setupSearch();
            
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ—Ç–∫—Ä—ã—Ç–æ–µ –æ–∫–Ω–æ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏
            if (currentStop) {
                showStopInfo(currentStop, true);
            }
            
            // –ó–∞–ø—É—Å–∫–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É
            startUpdateInterval();
        }
        
        // –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        function saveData() {
            localStorage.setItem("buses", JSON.stringify(buses));
        }
        
        function handleSearchInput() {
            const query = this.value.toLowerCase().trim();
            searchResults.innerHTML = '';
            
            if (query.length < 2) {
                searchResults.style.display = 'none';
                return;
            }
            
            performSearch();
        }
        
        function performSearch() {
            const query = searchInput.value.toLowerCase().trim();
            searchResults.innerHTML = '';
            
            if (query.length < 1) {
                searchResults.style.display = 'none';
                return;
            }
            
            // –ü–æ–∏—Å–∫ –∞–≤—Ç–æ–±—É—Å–æ–≤
            const busMatches = Object.keys(buses).filter(
                bus => bus.toLowerCase().includes(query)
            ).sort((a, b) => parseInt(a) - parseInt(b)); // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –Ω–æ–º–µ—Ä–æ–≤ –∞–≤—Ç–æ–±—É—Å–æ–≤ –ø–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é
            
            // –ü–æ–∏—Å–∫ –æ—Å—Ç–∞–Ω–æ–≤–æ–∫
            let stopMatches = [];
            for (let bus in buses) {
                for (let stop in buses[bus]) {
                    if (stop.toLowerCase().includes(query) && !stopMatches.includes(stop)) {
                        stopMatches.push(stop);
                    }
                }
            }
            
            if (busMatches.length === 0 && stopMatches.length === 0) {
                searchResults.innerHTML = `<div class="not-found">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –ø–æ –≤–∞—à–µ–º—É –∑–∞–ø—Ä–æ—Å—É</div>`;
            } else {
                // –î–æ–±–∞–≤–ª—è–µ–º –Ω–∞–π–¥–µ–Ω–Ω—ã–µ –∞–≤—Ç–æ–±—É—Å—ã
                busMatches.forEach(bus => {
                    const item = document.createElement('div');
                    item.className = 'search-item';
                    item.innerHTML = `https://oskemenbus.kz/assets/images/ui-elements/vehicle-icons/single_bus.svg" width="16" height="16" style="margin-right: 6px;"> ${bus}`;
                    item.onclick = () => {
                        showRouteMap(bus);
                        searchResults.style.display = 'none';
                    };
                    searchResults.appendChild(item);
                });
                
                // –î–æ–±–∞–≤–ª—è–µ–º –Ω–∞–π–¥–µ–Ω–Ω—ã–µ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏
                stopMatches.forEach(stop => {
                    const item = document.createElement('div');
                    item.className = 'search-item';
                    item.innerHTML = `<img src="https://oskemenbus.kz/assets/images/map-icons/stop-icons/city_transport_stop.svg" width="40" height="40" style="margin-right: 6px;">${escapeHtml(stop)}`;
                    item.onclick = () => {
                        showStopInfo(stop);
                        searchResults.style.display = 'none';
                    };
                    searchResults.appendChild(item);
                });
            }
            
            searchResults.style.display = 'block';
        }
        
        function escapeHtml(unsafe) {
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }
        
        function setupSearch() {
            // –°–∫—Ä—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –ø–æ–ª—è –ø–æ–∏—Å–∫–∞
            document.addEventListener('click', function(e) {
                if (!searchInput.contains(e.target) && !searchResults.contains(e.target)) {
                    searchResults.style.display = 'none';
                }
            });
        }
        
        function addBus() {
            let busNumber = busNumberInput.value.trim();
            if (busNumber && !buses[busNumber]) {
                buses[busNumber] = {};
                saveData();
                renderBusList();
                busNumberInput.value = "";
            } else if (buses[busNumber]) {
                alert("–ê–≤—Ç–æ–±—É—Å —Å —Ç–∞–∫–∏–º –Ω–æ–º–µ—Ä–æ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç!");
            }
        }
        
        function renderBusList() {
            busList.innerHTML = "";

            if (Object.keys(buses).length === 0) {
                busList.innerHTML = "<p>–ù–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã—Ö –∞–≤—Ç–æ–±—É—Å–æ–≤</p>";
                return;
            }

            // –°–æ—Ä—Ç–∏—Ä—É–µ–º –∞–≤—Ç–æ–±—É—Å—ã –ø–æ –Ω–æ–º–µ—Ä—É
            let sortedBusNumbers = Object.keys(buses).sort((a, b) => parseInt(a) - parseInt(b));

            for (let bus of sortedBusNumbers) {
                let div = document.createElement("div");
                div.className = "bus-list-item";
                div.innerHTML = `
                    <div class="bus-item">
                        <div class="bus-header">
                            <div class="bus-number-container">
                                <div class="bus-number">
                                    <img src="https://oskemenbus.kz/assets/images/ui-elements/vehicle-icons/single_bus.svg" alt="Bus" style="width:20px; height:20px;">
                                    ${escapeHtml(bus)}
                                </div>
                            </div>
                            <div class="bus-actions">
                                ${isAdminMode ? `
                                    <button class="action-btn admin-action" onclick="openAddStopWindow('${bus}')">–î–æ–±–∞–≤–∏—Ç—å –æ—Å—Ç–∞–Ω–æ–≤–∫—É</button>
                                    <button class="action-btn admin-action" onclick="editBusSchedule('${bus}')">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                                    <button class="action-btn danger-action" onclick="deleteBus('${bus}')">–£–¥–∞–ª–∏—Ç—å</button>
                                ` : ''}
                                <button class="action-btn" onclick="showRouteMap('${bus}')">–ú–∞—Ä—à—Ä—É—Ç</button>
                                <button class="action-btn" onclick="showSchedule('${bus}')">–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ</button>
                                <button class="action-btn" onclick="showFullSchedule('${bus}')">–ü–æ–ª–Ω–æ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ</button>
                                <button class="action-btn gps-btn" onclick="showBusOnMap('${bus}')">
                                    –ü–æ–∫–∞–∑–∞—Ç—å –Ω–∞ –∫–∞—Ä—Ç–µ 
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="bus-window" id="bus-window-${bus}"></div>
                `;
                busList.appendChild(div);
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ –∞–≤—Ç–æ–±—É—Å–∞ –Ω–∞ –∫–∞—Ä—Ç–µ
        function showBusOnMap(busNumber) {
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∫–∞—Ä—Ç—ã
            mapContainer.style.display = 'block';
            
            // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ –∫–∞—Ä—Ç–µ
            mapContainer.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
        
        // –§—É–Ω–∫—Ü–∏—è –∑–∞–∫—Ä—ã—Ç–∏—è –∫–∞—Ä—Ç—ã
        function closeMap() {
            mapContainer.style.display = 'none';
        }
        
        function deleteBus(busNumber) {
            if (confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –∞–≤—Ç–æ–±—É—Å ${busNumber} –∏ –≤—Å–µ –µ–≥–æ –¥–∞–Ω–Ω—ã–µ?`)) {
                delete buses[busNumber];
                saveData();
                renderBusList();
                
                // –ó–∞–∫—Ä—ã–≤–∞–µ–º –æ–∫–Ω–æ —ç—Ç–æ–≥–æ –∞–≤—Ç–æ–±—É—Å–∞, –µ—Å–ª–∏ –æ–Ω–æ –æ—Ç–∫—Ä—ã—Ç–æ
                document.getElementById(`bus-window-${busNumber}`).style.display = 'none';
                document.getElementById(`bus-window-${busNumber}`).innerHTML = '';
            }
        }
        
        function openAddStopWindow(busNumber) {
            let busWindow = document.getElementById(`bus-window-${busNumber}`);
            
            busWindow.innerHTML = `
                <div class="container">
                    <h3>–î–æ–±–∞–≤–∏—Ç—å –æ—Å—Ç–∞–Ω–æ–≤–∫—É –¥–ª—è –∞–≤—Ç–æ–±—É—Å–∞ ${busNumber}</h3>
                    <div class="add-stop-container">
                        <input type="text" id="stopName-${busNumber}" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏">
                        <input type="text" id="stopTimes-${busNumber}" placeholder="–í—Ä–µ–º—è (—Ñ–æ—Ä–º–∞—Ç: 08:00,12:30,18:15)">
                    </div>
                    <div class="action-buttons">
                        <button class="action-btn admin-action" onclick="addStopToBus('${busNumber}')">–î–æ–±–∞–≤–∏—Ç—å</button>
                        <button class="action-btn" onclick="closeBusWindow('${busNumber}')">–û—Ç–º–µ–Ω–∞</button>
                    </div>
                </div>
            `;
            busWindow.style.display = 'block';
        }
        
        function addStopToBus(busNumber) {
            let stopName = document.getElementById(`stopName-${busNumber}`).value.trim();
            let stopTimes = document.getElementById(`stopTimes-${busNumber}`).value.trim();
            
            if (!stopName || !stopTimes) {
                alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è!");
                return;
            }
            
            // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º —Å—Ç—Ä–æ–∫—É –≤—Ä–µ–º–µ–Ω–∏ –≤ –º–∞—Å—Å–∏–≤
            let timesArray = stopTimes.split(',').map(time => time.trim()).filter(time => time);
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–æ—Ä–º–∞—Ç –≤—Ä–µ–º–µ–Ω–∏
            let timeRegex = /^([0-1]?[0-9]|2[0-3]):[0-5][0-9]$/;
            for (let time of timesArray) {
                if (!timeRegex.test(time)) {
                    alert(`–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –≤—Ä–µ–º–µ–Ω–∏: ${time}. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ñ–æ—Ä–º–∞—Ç –ß–ß:MM`);
                    return;
                }
            }
            
            // –î–æ–±–∞–≤–ª—è–µ–º –æ—Å—Ç–∞–Ω–æ–≤–∫—É
            buses[busNumber][stopName] = timesArray;
            saveData();
            
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º –æ–∫–Ω–æ –∏ –æ–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫
            closeBusWindow(busNumber);
            renderBusList();
            renderStopsList(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –æ—Å—Ç–∞–Ω–æ–≤–æ–∫
        }
        
        function editBusSchedule(busNumber) {
            let busWindow = document.getElementById(`bus-window-${busNumber}`);
            
            if (!buses[busNumber] || Object.keys(buses[busNumber]).length === 0) {
                busWindow.innerHTML = `
                    <div class="container">
                        <p>–î–ª—è —ç—Ç–æ–≥–æ –∞–≤—Ç–æ–±—É—Å–∞ –Ω–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã—Ö –æ—Å—Ç–∞–Ω–æ–≤–æ–∫.</p>
                        <button class="action-btn" onclick="closeBusWindow('${busNumber}')">–ó–∞–∫—Ä—ã—Ç—å</button>
                    </div>
                `;
                busWindow.style.display = 'block';
                return;
            }
            
            let stopsHTML = Object.keys(buses[busNumber]).map(stop => {
                return `
                    <div class="stop-item">
                        <div class="stop-name">${escapeHtml(stop)}</div>
                        <div class="stop-times">${buses[busNumber][stop].join(', ')}</div>
                        <div class="edit-stop-actions">
                            <button class="action-btn admin-action" onclick="editStop('${busNumber}', '${escapeHtml(stop)}')">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                            <button class="action-btn danger-action" onclick="deleteStop('${busNumber}', '${escapeHtml(stop)}')">–£–¥–∞–ª–∏—Ç—å</button>
                        </div>
                    </div>
                `;
            }).join('');
            
            busWindow.innerHTML = `
                <div class="container">
                    <h3>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è –∞–≤—Ç–æ–±—É—Å–∞ ${busNumber}</h3>
                    <div class="edit-bus-form">
                        <input type="text" id="editBusNumber" value="${escapeHtml(busNumber)}" placeholder="–ù–æ–≤—ã–π –Ω–æ–º–µ—Ä –∞–≤—Ç–æ–±—É—Å–∞">
                        <input type="text" id="editBusName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∞–≤—Ç–æ–±—É—Å–∞ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)">
                    </div>
                    ${stopsHTML}
                    <div class="action-buttons">
                        <button class="action-btn admin-action" onclick="saveBusChanges('${busNumber}')">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
                        <button class="action-btn" onclick="closeBusWindow('${busNumber}')">–ó–∞–∫—Ä—ã—Ç—å</button>
                    </div>
                </div>
            `;
            busWindow.style.display = 'block';
        }
        
        function saveBusChanges(oldBusNumber) {
            let newBusNumber = document.getElementById('editBusNumber').value.trim();
            let busName = document.getElementById('editBusName').value.trim();
            
            if (!newBusNumber) {
                alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ –Ω–æ–º–µ—Ä –∞–≤—Ç–æ–±—É—Å–∞!");
                return;
            }
            
            if (newBusNumber !== oldBusNumber && buses[newBusNumber]) {
                alert("–ê–≤—Ç–æ–±—É—Å —Å —Ç–∞–∫–∏–º –Ω–æ–º–µ—Ä–æ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç!");
                return;
            }
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –∞–≤—Ç–æ–±—É—Å–∞
            if (newBusNumber !== oldBusNumber) {
                buses[newBusNumber] = buses[oldBusNumber];
                delete buses[oldBusNumber];
            }
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –∞–≤—Ç–æ–±—É—Å–∞, –µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω–æ
            if (busName) {
                buses[newBusNumber]._name = busName;
            }
            
            saveData();
            renderBusList();
            closeBusWindow(newBusNumber);
        }
        
        function editStop(busNumber, stopName) {
            let busWindow = document.getElementById(`bus-window-${busNumber}`);
            
            busWindow.innerHTML = `
                <div class="container">
                    <h3>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ "${stopName}"</h3>
                    <div class="edit-stop-form">
                        <input type="text" id="editStopName-${busNumber}" value="${escapeHtml(stopName)}" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏">
                        <input type="text" id="editStopTimes-${busNumber}" value="${buses[busNumber][stopName].join(', ')}" placeholder="–í—Ä–µ–º—è (—Ñ–æ—Ä–º–∞—Ç: 08:00,12:30,18:15)">
                        <div class="edit-stop-actions">
                            <button class="action-btn admin-action" onclick="saveStopChanges('${busNumber}', '${escapeHtml(stopName)}')">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                            <button class="action-btn" onclick="editBusSchedule('${busNumber}')">–û—Ç–º–µ–Ω–∞</button>
                        </div>
                    </div>
                </div>
            `;
            busWindow.style.display = 'block';
        }
        
        function saveStopChanges(busNumber, oldStopName) {
            let newStopName = document.getElementById(`editStopName-${busNumber}`).value.trim();
            let stopTimes = document.getElementById(`editStopTimes-${busNumber}`).value.trim();
            
            if (!newStopName || !stopTimes) {
                alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è!");
                return;
            }
            
            // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º —Å—Ç—Ä–æ–∫—É –≤—Ä–µ–º–µ–Ω–∏ –≤ –º–∞—Å—Å–∏–≤
            let timesArray = stopTimes.split(',').map(time => time.trim()).filter(time => time);
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–æ—Ä–º–∞—Ç –≤—Ä–µ–º–µ–Ω–∏
            let timeRegex = /^([0-1]?[0-9]|2[0-3]):[0-5][0-9]$/;
            for (let time of timesArray) {
                if (!timeRegex.test(time)) {
                    alert(`–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –≤—Ä–µ–º–µ–Ω–∏: ${time}. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ñ–æ—Ä–º–∞—Ç –ß–ß:MM`);
                    return;
                }
            }
            
            // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—É—é –æ—Å—Ç–∞–Ω–æ–≤–∫—É, –µ—Å–ª–∏ –∏–º—è –∏–∑–º–µ–Ω–∏–ª–æ—Å—å
            if (oldStopName !== newStopName) {
                delete buses[busNumber][oldStopName];
            }
            
            // –î–æ–±–∞–≤–ª—è–µ–º/–æ–±–Ω–æ–≤–ª—è–µ–º –æ—Å—Ç–∞–Ω–æ–≤–∫—É
            buses[busNumber][newStopName] = timesArray;
            saveData();
            
            // –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –∫ —Å–ø–∏—Å–∫—É –æ—Å—Ç–∞–Ω–æ–≤–æ–∫
            editBusSchedule(busNumber);
            renderStopsList(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –æ—Å—Ç–∞–Ω–æ–≤–æ–∫
        }
        
        function deleteStop(busNumber, stopName) {
            if (confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –æ—Å—Ç–∞–Ω–æ–≤–∫—É "${stopName}" –∏–∑ –º–∞—Ä—à—Ä—É—Ç–∞ –∞–≤—Ç–æ–±—É—Å–∞ ${busNumber}?`)) {
                delete buses[busNumber][stopName];
                saveData();
                editBusSchedule(busNumber);
                renderStopsList(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –æ—Å—Ç–∞–Ω–æ–≤–æ–∫
            }
        }
        
        function showRouteMap(busNumber) {
            searchResults.style.display = 'none';
            let busWindow = document.getElementById(`bus-window-${busNumber}`);
            
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –¥—Ä—É–≥–∏–µ –æ–∫–Ω–∞
            document.querySelectorAll('.bus-window').forEach(window => {
                if (window.id !== `bus-window-${busNumber}`) {
                    window.style.display = 'none';
                    window.innerHTML = '';
                }
            });
            
            let stops = Object.keys(buses[busNumber]);
            if (stops.length === 0) {
                busWindow.innerHTML = `
                    <div class="container">
                        <p>–î–ª—è —ç—Ç–æ–≥–æ –∞–≤—Ç–æ–±—É—Å–∞ –Ω–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã—Ö –æ—Å—Ç–∞–Ω–æ–≤–æ–∫.</p>
                        <button class="action-btn" onclick="closeBusWindow('${busNumber}')">–ó–∞–∫—Ä—ã—Ç—å</button>
                    </div>
                `;
                busWindow.style.display = 'block';
                return;
            }
            
            let firstStop = stops[0];
            let lastStop = stops[stops.length - 1];
            
            let routeMapHTML = stops.map((stop, index) => {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∏–¥–µ—Ç –ª–∏ –ø–æ—Å–∞–¥–∫–∞ –Ω–∞ —ç—Ç–æ–π –æ—Å—Ç–∞–Ω–æ–≤–∫–µ
                let now = new Date();
                let currentTime = now.getHours() * 60 + now.getMinutes();
                let isBoarding = false;
                
                if (buses[busNumber][stop]) {
                    for (let time of buses[busNumber][stop]) {
                        let [hours, minutes] = time.split(":").map(Number);
                        let timeInMinutes = hours * 60 + minutes;
                        if (currentTime >= timeInMinutes && currentTime < timeInMinutes + 1) {
                            isBoarding = true;
                            break;
                        }
                    }
                }
                
                let boardingStatus = isBoarding ? '<span class="boarding-status">–ò–¥–µ—Ç –ø–æ—Å–∞–¥–∫–∞</span>' : '';
                
                // –ü–æ–ª—É—á–∞–µ–º –±–ª–∏–∂–∞–π—à–∏–µ 2 –≤—Ä–µ–º–µ–Ω–∏ –ø—Ä–∏–±—ã—Ç–∏—è
                let nextTimes = [];
                if (buses[busNumber][stop]) {
                    let times = buses[busNumber][stop].map(time => {
                        let [hours, minutes] = time.split(":").map(Number);
                        return hours * 60 + minutes;
                    }).sort((a, b) => a - b);
                    
                    // –ù–∞—Ö–æ–¥–∏–º –±–ª–∏–∂–∞–π—à–∏–µ –≤—Ä–µ–º–µ–Ω–∞
                    for (let time of times) {
                        let remainingTime = time - currentTime;
                        if (remainingTime < 0) remainingTime += 1440; // –î–æ–±–∞–≤–ª—è–µ–º —Å—É—Ç–∫–∏, –µ—Å–ª–∏ –≤—Ä–µ–º—è —É–∂–µ –ø—Ä–æ—à–ª–æ
                        nextTimes.push(remainingTime);
                    }
                    
                    // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –≤—Ä–µ–º–µ–Ω–∏ –¥–æ –ø—Ä–∏–±—ã—Ç–∏—è
                    nextTimes.sort((a, b) => a - b);
                    
                    // –ë–µ—Ä–µ–º –¥–≤–∞ –±–ª–∏–∂–∞–π—à–∏—Ö –≤—Ä–µ–º–µ–Ω–∏
                    nextTimes = nextTimes.slice(0, 2);
                }
                
                // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –≤—Ä–µ–º—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
                let timeDisplay = nextTimes.map(time => {
                    if (time === 0) return '–ü—Ä–∏–±—ã–≤–∞–µ—Ç';
                    if (time === 1) return '<1 –º–∏–Ω';
                    if (time >= 60) {
                        let hours = Math.floor(time / 60);
                        let mins = time % 60;
                        return `${hours}—á ${mins}–º`;
                    }
                    return `${time} –º–∏–Ω`;
                }).join(', ');
                
                let stopHTML = `
                    <div class="stop" id="stop-${busNumber}-${index}">
                        <div class="stop-header" onclick="showStopInfo('${escapeHtml(stop)}');stopInfoWindow.scrollIntoView({ behavior: 'smooth', block: 'nearest' })">
                            <div class="circle"></div>
                            <div>
                                <div class="${stop === firstStop || stop === lastStop ? 'bold' : ''}">
                                    ${escapeHtml(stop)} ${boardingStatus}
                                </div>
                                <div class="stop-time-info">${timeDisplay || '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö'}</div>
                            </div>
                            <div class="arrow-right">
                                <img src="https://cdn-icons-png.flaticon.com/512/3652/3652191.png" class="calendar-icon" 
                                     onclick="event.stopPropagation(); showFullScheduleForStop('${busNumber}', '${escapeHtml(stop)}', event)">
                            </div>
                        </div>
                        <div class="full-schedule-container" id="schedule-${busNumber}-${escapeHtml(stop)}"></div>
                    </div>
                `;
                return stopHTML;
            }).join("");

            busWindow.innerHTML = `
                <div class="container">
                    <h4><img src="https://cdn3.iconfinder.com/data/icons/maps-and-pins-4/512/map_pin_destination_location_adress_bus_stop-1024.png" width="18" height="18"> –°—Ö–µ–º–∞ –º–∞—Ä—à—Ä—É—Ç–∞ –∞–≤—Ç–æ–±—É—Å–∞ ${escapeHtml(busNumber)}</h4>
                    <div class="route-map">
                        ${routeMapHTML}
                    </div>
                    <button class="action-btn" onclick="closeBusWindow('${busNumber}')">–ó–∞–∫—Ä—ã—Ç—å</button>
                </div>
            `;
            busWindow.style.display = 'block';
            
            // –î–æ–±–∞–≤–ª—è–µ–º –º–∞—Ä–∫–µ—Ä –∞–≤—Ç–æ–±—É—Å–∞ –∏ –æ–±–Ω–æ–≤–ª—è–µ–º –µ–≥–æ –ø–æ–∑–∏—Ü–∏—é
            updateBusMarkerPosition(busNumber);
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–æ–ª–Ω–æ–≥–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –æ—Å—Ç–∞–Ω–æ–≤–∫–∏
        function showFullScheduleForStop(busNumber, stopName, event) {
            if (event) event.stopPropagation();
            
            let scheduleContainer = document.getElementById(`schedule-${busNumber}-${escapeHtml(stopName)}`);
            
            if (scheduleContainer.style.display === 'block') {
                scheduleContainer.style.display = 'none';
                scheduleContainer.innerHTML = '';
                return;
            }
            
            document.querySelectorAll('.full-schedule-container').forEach(container => {
                if (container.id !== `schedule-${busNumber}-${escapeHtml(stopName)}`) {
                    container.style.display = 'none';
                    container.innerHTML = '';
                }
            });
            
            let schedule = buses[busNumber][stopName];
            if (!schedule || schedule.length === 0) {
                scheduleContainer.innerHTML = '<p>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–∏</p>';
                scheduleContainer.style.display = 'block';
                return;
            }
            
            let scheduleByHours = {};
            schedule.forEach(time => {
                let [hours, minutes] = time.split(':');
                if (!scheduleByHours[hours]) {
                    scheduleByHours[hours] = [];
                }
                scheduleByHours[hours].push(minutes);
            });
            
            let sortedHours = Object.keys(scheduleByHours).sort();
            let now = new Date();
            let currentTime = now.getHours() * 60 + now.getMinutes();
            
            // –ù–∞—Ö–æ–¥–∏–º –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è —Å—Ä–µ–¥–∏ –≤—Å–µ—Ö –≤—Ä–µ–º–µ–Ω
            let allTimes = [];
            for (let hour in scheduleByHours) {
                scheduleByHours[hour].forEach(min => {
                    let timeInMinutes = parseInt(hour) * 60 + parseInt(min);
                    // –ï—Å–ª–∏ –≤—Ä–µ–º—è —É–∂–µ –ø—Ä–æ—à–ª–æ —Å–µ–≥–æ–¥–Ω—è, –¥–æ–±–∞–≤–ª—è–µ–º –µ–≥–æ –∫–∞–∫ –≤—Ä–µ–º—è —Å–ª–µ–¥—É—é—â–µ–≥–æ –¥–Ω—è
                    if (timeInMinutes < currentTime) {
                        allTimes.push(timeInMinutes + 1440); // +24 —á–∞—Å–∞
                    } else {
                        allTimes.push(timeInMinutes);
                    }
                });
            }
            
            // –°–æ—Ä—Ç–∏—Ä—É–µ–º –≤—Å–µ –≤—Ä–µ–º–µ–Ω–∞ –∏ –Ω–∞—Ö–æ–¥–∏–º –±–ª–∏–∂–∞–π—à–µ–µ
            allTimes.sort((a, b) => a - b);
            let nearestTime = allTimes[0];
            
            // –ï—Å–ª–∏ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è - –∑–∞–≤—Ç—Ä–∞—à–Ω–µ–µ, –ø—Ä–∏–≤–æ–¥–∏–º –µ–≥–æ –∫ —Å–µ–≥–æ–¥–Ω—è—à–Ω–µ–º—É —Ñ–æ—Ä–º–∞—Ç—É
            if (nearestTime >= 1440) {
                nearestTime -= 1440;
            }
            
            let scheduleHTML = `
                <div style="margin-bottom: 10px; text-align: center;">
                    <center><img src="https://oskemenbus.kz/assets/images/ui-elements/vehicle-icons/single_bus.svg" width="18" height="18">  <strong>–ê–≤—Ç–æ–±—É—Å ${busNumber}</strong></center>
                    <center>${stopName}</center>
                </div>
            `;
            
            sortedHours.forEach(hour => {
                let minutesList = scheduleByHours[hour];
                let hourInt = parseInt(hour);
                
                scheduleHTML += `
                    <div class="hour-block">
                        <div class="hour-label">${hour}—á</div>
                        <div class="minutes-list">
                            ${minutesList.map(min => {
                                let timeInMinutes = hourInt * 60 + parseInt(min);
                                let isCurrent = timeInMinutes === nearestTime;
                                return `<span class="minute-item ${isCurrent ? 'current-minute' : ''}">${min}</span>`;
                            }).join('')}
                        </div>
                    </div>
                `;
            });
            
            scheduleContainer.innerHTML = scheduleHTML;
            scheduleContainer.style.display = 'block';
        }

        function showFullSchedule(busNumber) {
            searchResults.style.display = 'none';
            let busWindow = document.getElementById(`bus-window-${busNumber}`);
            
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –¥—Ä—É–≥–∏–µ –æ–∫–Ω–∞
            document.querySelectorAll('.bus-window').forEach(window => {
                if (window.id !== `bus-window-${busNumber}`) {
                    window.style.display = 'none';
                    window.innerHTML = '';
                }
            });
            
            let stops = buses[busNumber];
            let now = new Date();
            let currentTime = now.getHours() * 60 + now.getMinutes();
            
            let scheduleHTML = Object.entries(stops).map(([stop, times]) => {
                // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –≤—Ä–µ–º—è –ø–æ —á–∞—Å–∞–º
                let scheduleByHours = {};
                times.forEach(time => {
                    let [hours, minutes] = time.split(':');
                    if (!scheduleByHours[hours]) {
                        scheduleByHours[hours] = [];
                    }
                    scheduleByHours[hours].push(minutes);
                });
                
                // –°–æ—Ä—Ç–∏—Ä—É–µ–º —á–∞—Å—ã
                let sortedHours = Object.keys(scheduleByHours).sort();
                
                // –ù–∞—Ö–æ–¥–∏–º –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è –¥–ª—è —ç—Ç–æ–π –æ—Å—Ç–∞–Ω–æ–≤–∫–∏
                let allTimes = [];
                for (let hour in scheduleByHours) {
                    scheduleByHours[hour].forEach(min => {
                        let timeInMinutes = parseInt(hour) * 60 + parseInt(min);
                        if (timeInMinutes < currentTime) {
                            allTimes.push(timeInMinutes + 1440);
                        } else {
                            allTimes.push(timeInMinutes);
                        }
                    });
                }
                
                allTimes.sort((a, b) => a - b);
                let nearestTime = allTimes[0];
                if (nearestTime >= 1440) {
                    nearestTime -= 1440;
                }
                
                let stopScheduleHTML = sortedHours.map(hour => {
                    let minutesList = scheduleByHours[hour];
                    let hourInt = parseInt(hour);
                    
                    return `
                        <div class="hour-block">
                            <div class="hour-label">${hour}—á</div>
                            <div class="minutes-list">
                                ${minutesList.map(min => {
                                    let timeInMinutes = hourInt * 60 + parseInt(min);
                                    let isCurrent = timeInMinutes === nearestTime;
                                    return `<span class="minute-item ${isCurrent ? 'current-minute' : ''}">${min}</span>`;
                                }).join('')}
                            </div>
                        </div>
                    `;
                }).join('');
                
                return `
                    <center><div class="stop-item">
                        <div class="stop-name">${escapeHtml(stop)}</div>
                        ${stopScheduleHTML}
                    </div></center>
                `;
            }).join("");

            busWindow.innerHTML = `
                <div class="container">
                    <h3 class="full-schedule-title" style="text-align: center;"><img src="https://oskemenbus.kz/assets/images/ui-elements/vehicle-icons/single_bus.svg" width="18" height="18"> –ü–æ–ª–Ω–æ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –∞–≤—Ç–æ–±—É—Å–∞ ${escapeHtml(busNumber)}</h3>
                    ${scheduleHTML}
                    <button class="action-btn" onclick="closeBusWindow('${busNumber}')">–ó–∞–∫—Ä—ã—Ç—å</button>
                </div>
            `;
            busWindow.style.display = 'block';
        }

        function getPixel(c) {
            return 6 + Math.floor(c / 2) * 161 + (c % 2) * 81;
        }
        
        function updateBusMarkerPosition(busNumber) {
            let busWindow = document.getElementById(`bus-window-${busNumber}`);
            if (!busWindow) return;
            
            // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π –º–∞—Ä–∫–µ—Ä, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
            if (busMarkers[busNumber]) {
                busMarkers[busNumber].remove();
            }
            
            let now = new Date();
            let currentTime = now.getHours() * 60 + now.getMinutes();
            let currentPosition = calculateBusPosition(busNumber, currentTime);
            
            if (!currentPosition) return;
            
            // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –º–∞—Ä–∫–µ—Ä
            let marker = document.createElement('img');
            marker.className = 'bus-marker';
            marker.src = "https://cdn3.iconfinder.com/data/icons/maps-and-pins-4/512/map_pin_destination_location_adress_bus_stop-1024.png";
            marker.width = 20;
            marker.height = 20;
            marker.style.display = 'none';
            marker.style.position = 'absolute';
            marker.style.zIndex = 10;
            busMarkers[busNumber] = marker;

            let stopElement = document.getElementById(`stop-${busNumber}-${currentPosition.stopIndex}`);
            if (!stopElement) return;

            if (currentPosition.position === 'at-stop') {
                let circle = stopElement.querySelector('.circle');
                if (circle) {
                    circle.appendChild(marker);

                    marker.style.display = 'block';
                    marker.style.top = getPixel(currentPosition.stopIndex) + 'px';
                }
            }

            busWindow.querySelector('.route-map').appendChild(marker);
            busPositions[busNumber] = currentPosition;
        }
        
        function calculateBusPosition(busNumber, currentTime) {
            let stops = Object.keys(buses[busNumber]);
            if (stops.length === 0) return null;

            // –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ –≤—Ä–µ–º–µ–Ω–∞ –ø—Ä–∏–±—ã—Ç–∏—è –¥–ª—è –≤—Å–µ—Ö –æ—Å—Ç–∞–Ω–æ–≤–æ–∫
            let allTimes = [];
            for (let i = 0; i < stops.length; i++) {
                let stop = stops[i];
                buses[busNumber][stop].forEach(time => {
                    let [hours, minutes] = time.split(":").map(Number);
                    allTimes.push({
                        stopIndex: i,
                        stopName: stop,
                        time: hours * 60 + minutes
                    });
                });
            }

            // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –≤—Ä–µ–º–µ–Ω–∏
            allTimes.sort((a, b) => a.time - b.time);

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ª–∏ –∞–≤—Ç–æ–±—É—Å –Ω–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ (–≤—Ä–µ–º—è –ø–æ—Å–∞–¥–∫–∏)
            for (let i = 0; i < allTimes.length; i++) {
                if (currentTime >= allTimes[i].time && currentTime < allTimes[i].time + 1) {
                    return {
                        stopIndex: allTimes[i].stopIndex,
                        position: 'at-stop',
                        stopName: allTimes[i].stopName,
                        boarding: true
                    };
                }
            }

            // –ù–∞—Ö–æ–¥–∏–º —Ç–µ–∫—É—â–∏–π –∏ —Å–ª–µ–¥—É—é—â–∏–π –æ—Ç—Ä–µ–∑–æ–∫ –º–∞—Ä—à—Ä—É—Ç–∞
            let current = null;
            let next = null;
            
            for (let i = 0; i < allTimes.length; i++) {
                if (allTimes[i].time < currentTime) {
                    current = allTimes[i];
                } else {
                    next = allTimes[i];
                    break;
                }
            }

            // –ï—Å–ª–∏ –∞–≤—Ç–æ–±—É—Å –∑–∞–≤–µ—Ä—à–∏–ª –º–∞—Ä—à—Ä—É—Ç
            if (!next) {
                next = allTimes[0];
                next.time += 1440; // –î–æ–±–∞–≤–ª—è–µ–º —Å—É—Ç–∫–∏ (–ø–µ—Ä–≤—ã–π —Ä–µ–π—Å —Å–ª–µ–¥—É—é—â–µ–≥–æ –¥–Ω—è)
            }

            // –ï—Å–ª–∏ –∞–≤—Ç–æ–±—É—Å –µ—â–µ –Ω–µ –Ω–∞—á–∞–ª –º–∞—Ä—à—Ä—É—Ç
            if (!current) {
                current = allTimes[allTimes.length - 1];
                current.time -= 1440; // –í—ã—á–∏—Ç–∞–µ–º —Å—É—Ç–∫–∏ (–ø–æ—Å–ª–µ–¥–Ω–∏–π —Ä–µ–π—Å –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –¥–Ω—è)
            }

            // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –º–µ–∂–¥—É –æ—Å—Ç–∞–Ω–æ–≤–∫–∞–º–∏
            let totalTime = next.time - current.time;
            let timePassed = currentTime - current.time;
            let progress = timePassed / totalTime;

            // –ï—Å–ª–∏ –∞–≤—Ç–æ–±—É—Å –º–µ–∂–¥—É –æ—Å—Ç–∞–Ω–æ–≤–∫–∞–º–∏
            if (progress > 0 && progress < 1) {
                return {
                    stopIndex: current.stopIndex,
                    position: 'between-stops',
                    progress: progress,
                    nextStopIndex: next.stopIndex,
                    currentStopName: current.stopName,
                    nextStopName: next.stopName
                };
            }

            // –ï—Å–ª–∏ –∞–≤—Ç–æ–±—É—Å —Ç–æ–ª—å–∫–æ —á—Ç–æ –ø–æ–∫–∏–Ω—É–ª –æ—Å—Ç–∞–Ω–æ–≤–∫—É
            return {
                stopIndex: current.stopIndex,
                position: 'at-stop',
                stopName: current.stopName,
                boarding: false
            };
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ –≤—Å–µ—Ö –æ—Å—Ç–∞–Ω–æ–≤–æ–∫
        function renderStopsList() {
            stopsList.innerHTML = "";
            
            // –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –∏–∑ –≤—Å–µ—Ö –∞–≤—Ç–æ–±—É—Å–æ–≤
            let allStops = new Set();
            for (let bus in buses) {
                for (let stop in buses[bus]) {
                    allStops.add(stop);
                }
            }
            
            if (allStops.size === 0) {
                stopsList.innerHTML = "<p>–ù–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã—Ö –æ—Å—Ç–∞–Ω–æ–≤–æ–∫</p>";
                return;
            }
            
            // –°–æ—Ä—Ç–∏—Ä—É–µ–º –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø–æ –∞–ª—Ñ–∞–≤–∏—Ç—É
            let sortedStops = Array.from(allStops).sort();
            
            // –°–æ–∑–¥–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã –¥–ª—è –∫–∞–∂–¥–æ–π –æ—Å—Ç–∞–Ω–æ–≤–∫–∏
            sortedStops.forEach(stop => {
                let div = document.createElement("div");
                div.className = "bus-item";
                div.innerHTML = `
                    <div class="search-item" onclick="showStopInfo('${escapeHtml(stop)}')">
                        <img src="https://oskemenbus.kz/assets/images/map-icons/stop-icons/city_transport_stop.svg" width="50" height="50—ã" style="margin-right: 6px;">
                        ${escapeHtml(stop)}
                    </div>
                `;
                stopsList.appendChild(div);
            });
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –≤–∏–¥–∏–º–æ—Å—Ç–∏ —Å–ø–∏—Å–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–æ–∫
        function toggleStopsList() {
            if (stopsListContainer.classList.contains('hidden')) {
                stopsListContainer.classList.remove('hidden');
                renderStopsList();
            } else {
                stopsListContainer.classList.add('hidden');
            }
        }

        function showStopInfo(stopName, fromStorage = false) {
            searchResults.style.display = 'none';
            stopsListContainer.classList.add('hidden'); // –°–∫—Ä—ã–≤–∞–µ–º —Å–ø–∏—Å–æ–∫ –æ—Å—Ç–∞–Ω–æ–≤–æ–∫ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â—É—é –æ—Å—Ç–∞–Ω–æ–≤–∫—É
            if (!fromStorage) {
                currentStop = stopName;
                localStorage.setItem("currentStop", stopName);
            }
            
            // –ù–∞–π–¥–µ–º –≤—Å–µ –∞–≤—Ç–æ–±—É—Å—ã, –∫–æ—Ç–æ—Ä—ã–µ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—Ç—Å—è –Ω–∞ —ç—Ç–æ–π –æ—Å—Ç–∞–Ω–æ–≤–∫–µ
            let busesAtStop = [];
            for (let bus in buses) {
                if (buses[bus][stopName]) {
                    busesAtStop.push({
                        number: bus,
                        times: buses[bus][stopName]
                    });
                }
            }
            
            // –°–æ—Ä—Ç–∏—Ä—É–µ–º –∞–≤—Ç–æ–±—É—Å—ã –ø–æ –Ω–æ–º–µ—Ä—É (–ø–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é)
            busesAtStop.sort((a, b) => parseInt(a.number) - parseInt(b.number));
            
            // –ü–æ–ª—É—á–∏–º –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∞–≤—Ç–æ–±—É—Å–∞
            let now = new Date();
            let currentTime = now.getHours() * 60 + now.getMinutes();
            
            // –°–æ–∑–¥–∞–µ–º –º–∞—Å—Å–∏–≤ –¥–ª—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø—Ä–∏–±—ã—Ç–∏–∏ –∞–≤—Ç–æ–±—É—Å–æ–≤
            let arrivalInfo = busesAtStop.map(bus => {
                let times = bus.times.map(time => {
                    let [hours, minutes] = time.split(":").map(Number);
                    return hours * 60 + minutes;
                }).sort((a, b) => a - b);
                
                // –ù–∞—Ö–æ–¥–∏–º –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è
                let nextTime = getNextArrivalTime(bus.times, currentTime);
                let remainingTime = nextTime - currentTime;
                if (remainingTime < 0) remainingTime += 1440;
                
                let isBoarding = false;
                for (let time of times) {
                    if (currentTime >= time && currentTime < time + 1) {
                        isBoarding = true;
                        remainingTime = 0;
                        break;
                    }
                }
                
                return {
                    busNumber: bus.number,
                    remainingTime: remainingTime,
                    isBoarding: isBoarding,
                    nextTime: nextTime
                };
            });
            
            // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –≤—Ä–µ–º–µ–Ω–∏ –ø—Ä–∏–±—ã—Ç–∏—è (—Å–Ω–∞—á–∞–ª–∞ —Ç–µ, —á—Ç–æ –ø—Ä–∏–±—ã–≤–∞—é—Ç, –∑–∞—Ç–µ–º –ø–æ –≤—Ä–µ–º–µ–Ω–∏)
            arrivalInfo.sort((a, b) => {
                // –ï—Å–ª–∏ –æ–¥–∏–Ω –∏–∑ –∞–≤—Ç–æ–±—É—Å–æ–≤ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —Å—Ç–∞—Ç—É—Å–µ "–ü—Ä–∏–±—ã–≤–∞–µ—Ç", –æ–Ω –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø–µ—Ä–≤—ã–º
                if (a.isBoarding && !b.isBoarding) return -1;
                if (!a.isBoarding && b.isBoarding) return 1;
                
                // –ò–Ω–∞—á–µ —Å–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –≤—Ä–µ–º–µ–Ω–∏ –¥–æ –ø—Ä–∏–±—ã—Ç–∏—è
                return a.remainingTime - b.remainingTime;
            });
            
            // –°–æ–∑–¥–∞–µ–º HTML –¥–ª—è –Ω–æ–º–µ—Ä–æ–≤ –∞–≤—Ç–æ–±—É—Å–æ–≤ (—Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –Ω–æ–º–µ—Ä—É)
            let busNumbersHTML = busesAtStop.map(bus => bus.number).join(', ');
            
            // –°–æ–∑–¥–∞–µ–º HTML –¥–ª—è –≤—Ä–µ–º–µ–Ω–∏ –ø—Ä–∏–±—ã—Ç–∏—è –∞–≤—Ç–æ–±—É—Å–æ–≤ (—Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –≤—Ä–µ–º–µ–Ω–∏)
            let busTimesHTML = arrivalInfo.map(info => {
                let remainingTimeFormatted;
                if (info.isBoarding) {
                    remainingTimeFormatted = `<span class="arriving-text">–ü—Ä–∏–±—ã–≤–∞–µ—Ç</span>`;
                } else if (info.remainingTime === 1) {
                    remainingTimeFormatted = "&lt;1 –º–∏–Ω";
                } else if (info.remainingTime >= 60) {
                    let hours = Math.floor(info.remainingTime / 60);
                    let mins = info.remainingTime % 60;
                    remainingTimeFormatted = `${hours}—á ${mins}–º`;
                } else {
                    remainingTimeFormatted = `${info.remainingTime} –º–∏–Ω`;
                }
            
                return `
                  <div class="bus-time-block" style="display: flex; flex-direction: column; align-items: flex-start; margin-bottom: 10px;">
                    <div class="bus-time-item">
                      <div class="bus-time-number">
                        <img src="https://oskemenbus.kz/assets/images/map-icons/vehicle-icons/icon/bus.svg" width="32" height="32" style="margin-top: -1px; position: relative; left: 2px;">
                        ${escapeHtml(info.busNumber)}
                      </div>
                    </div>
                    <div class="bus-time-arrival" style="margin-top: 2px;">
                      <span class="bus-time-dot"></span>
                      ${remainingTimeFormatted}
                    </div>
                  </div>
                `;
            }).join("");
            
            stopInfoWindow.innerHTML = `
              <div class="stop-info-window">
                <div class="stop-info-title">${escapeHtml(stopName)}</div>
                <div class="stop-info-subtitle">–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç –Ω–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ</div>
                <div class="bus-numbers-list">
                  <img src="https://oskemenbus.kz/assets/images/ui-elements/vehicle-icons/single_bus.svg" width="15" height="15" style="margin-top: -1px">
                  ${busNumbersHTML}
                </div>
                <div class="bus-time-container">
                  ${busTimesHTML}
                </div>
                <div class="action-buttons" style="margin-top: 15px;">
                  <button class="action-button" onclick="showMap('${escapeHtml(stopName)}')">–ö–∞—Ä—Ç–∞</button>
                  <button class="action-button" onclick="showStopSchedule('${escapeHtml(stopName)}')">–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ</button>
                  <button class="action-button" onclick="addToFavorites('${escapeHtml(stopName)}')">–ò–∑–±—Ä–∞–Ω–Ω–æ–µ</button>
                  <button class="action-button" onclick="showRouteFromStop('${escapeHtml(stopName)}')">–ú–∞—Ä—à—Ä—É—Ç</button>
                </div>
                <button class="action-btn" onclick="closeStopWindow()" style="margin-top: 12px; width: 100%; padding: 8px; font-size: 14px;">–ó–∞–∫—Ä—ã—Ç—å</button>
              </div>
            `;
            stopInfoWindow.style.display = 'block';
            
            // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ –æ–∫–Ω—É —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π
            stopInfoWindow.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
        
        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –±–ª–∏–∂–∞–π—à–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –ø—Ä–∏–±—ã—Ç–∏—è
        function getNextArrivalTime(times, currentTime) {
            let timeValues = times.map(time => {
                let [hours, minutes] = time.split(":").map(Number);
                return hours * 60 + minutes;
            }).sort((a, b) => a - b);
            
            // –ù–∞—Ö–æ–¥–∏–º –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è, –∫–æ—Ç–æ—Ä–æ–µ –µ—â–µ –Ω–µ –ø—Ä–æ—à–ª–æ
            for (let time of timeValues) {
                if (time > currentTime) {
                    return time;
                }
            }
            
            // –ï—Å–ª–∏ –≤—Å–µ –≤—Ä–µ–º–µ–Ω–∞ –ø—Ä–æ—à–ª–∏, –±–µ—Ä–µ–º –ø–µ—Ä–≤–æ–µ –≤—Ä–µ–º—è —Å–ª–µ–¥—É—é—â–µ–≥–æ –¥–Ω—è
            return timeValues[0] + 1440;
        }
        
        function closeStopWindow() {
            stopInfoWindow.style.display = 'none';
            currentStop = null;
            localStorage.removeItem("currentStop");
        }
        
        function startUpdateInterval() {
            if (updateInterval) {
                clearInterval(updateInterval);
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥ –¥–ª—è –ø–ª–∞–≤–Ω–æ—Å—Ç–∏ –¥–≤–∏–∂–µ–Ω–∏—è
            updateInterval = setInterval(() => {
                let now = new Date();
                let currentTime = now.getHours() * 60 + now.getMinutes();
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –æ—Å—Ç–∞–Ω–æ–≤–∫–µ
                if (currentStop) {
                    showStopInfo(currentStop, true);
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –º–∞—Ä–∫–µ—Ä—ã –≤—Å–µ—Ö –∞–≤—Ç–æ–±—É—Å–æ–≤
                for (let busNumber in buses) {
                    updateBusMarkerPosition(busNumber);
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–∫—Ä—ã—Ç—ã–µ –æ–∫–Ω–∞
                    let busWindow = document.getElementById(`bus-window-${busNumber}`);
                    if (busWindow && busWindow.style.display === 'block') {
                        if (busWindow.innerHTML.includes("–°—Ö–µ–º–∞ –º–∞—Ä—à—Ä—É—Ç–∞")) {
                            showRouteMap(busNumber);
                        } else if (busWindow.innerHTML.includes("–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ")) {
                            showSchedule(busNumber);
                        } else if (busWindow.innerHTML.includes("–ü–æ–ª–Ω–æ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ")) {
                            showFullSchedule(busNumber);
                        }
                    }
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–∫—Ä—ã—Ç—ã–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è –æ—Å—Ç–∞–Ω–æ–≤–æ–∫
                    document.querySelectorAll('.full-schedule-container').forEach(container => {
                        if (container.style.display === 'block') {
                            let idParts = container.id.split('-');
                            let busNum = idParts[1];
                            let stopName = idParts.slice(3).join('-');
                            showFullScheduleForStop(busNum, stopName, {stopPropagation: () => {}});
                        }
                    });
                }
            }, 60000); // 1 —Å–µ–∫—É–Ω–¥–∞ –≤–º–µ—Å—Ç–æ 60 –¥–ª—è –±–æ–ª–µ–µ –ø–ª–∞–≤–Ω–æ–≥–æ –¥–≤–∏–∂–µ–Ω–∏—è
        }
        
        function showSchedule(busNumber) {
            searchResults.style.display = 'none';
            let busWindow = document.getElementById(`bus-window-${busNumber}`);
            
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –¥—Ä—É–≥–∏–µ –æ–∫–Ω–∞
            document.querySelectorAll('.bus-window').forEach(window => {
                if (window.id !== `bus-window-${busNumber}`) {
                    window.style.display = 'none';
                    window.innerHTML = '';
                }
            });
            
            let nextBus = getNextBusForAllStops(busNumber);
            
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –∞–≤—Ç–æ–±—É—Å–∞
            let statusText = "";
            let statusClass = "";
            
            if (nextBus.status === "üü¢–ü—Ä–∏–±—ã–≤–∞–µ—Ç") {
                statusText = "–ü—Ä–∏–±—ã–≤–∞–µ—Ç –Ω–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫—É";
                statusClass = "boarding";
            } else if (nextBus.status === "üü°–í –ø—É—Ç–∏") {
                statusText = "–í –ø—É—Ç–∏";
                statusClass = "on-the-way";
            } else {
                statusText = "–û—Ñ—Ñ–ª–∞–π–Ω";
                statusClass = "offline";
            }
            
            busWindow.innerHTML = `
                <div class="container">
                    <h3><img src="https://oskemenbus.kz/assets/images/ui-elements/vehicle-icons/single_bus.svg" width="18" height="18"> –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –∞–≤—Ç–æ–±—É—Å–∞ ${escapeHtml(busNumber)}</h3>
                    <p>–°–ª–µ–¥—É—é—â–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞: <span class="next-stop">${escapeHtml(nextBus.stop)}</span></p>
                    <p>–°–ª–µ–¥—É—é—â–∏–π —Ä–µ–π—Å: ${nextBus.time}</p>
                    <p>–†–∞—Å—á–µ—Ç–Ω–æ–µ –≤—Ä–µ–º—è: <span class="highlight">${formatRemainingTime(nextBus.remaining)}</span></p>
                    <button class="action-btn" onclick="closeBusWindow('${busNumber}')">–ó–∞–∫—Ä—ã—Ç—å</button>
                </div>
            `;
            busWindow.style.display = 'block';
        }
        
        function formatRemainingTime(minutes) {
            if (minutes === 1) return "<1 –º–∏–Ω";
            if (minutes === 0) return '<span class="arriving-status">–ü—Ä–∏–±—ã–≤–∞–µ—Ç</span>';
            if (minutes >= 60) {
                let hours = Math.floor(minutes / 60);
                let mins = minutes % 60;
                return `${hours} —á ${mins} –º–∏–Ω`;
            } else {
                return `${minutes} –º–∏–Ω`;
            }
        }
        
        function getNextBusForAllStops(busNumber) {
            let now = new Date();
            let currentTime = now.getHours() * 60 + now.getMinutes();
            let stops = buses[busNumber];
            let nextBus = { time: "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö", stop: "", status: "üî¥ –û—Ñ—Ñ–ª–∞–π–Ω", remaining: 0 };

            let allTimes = [];
            for (let stop in stops) {
                let times = stops[stop].map(time => {
                    let [hours, minutes] = time.split(":").map(Number);
                    return { time: hours * 60 + minutes, stop: stop };
                });
                allTimes.push(...times);
            }

            allTimes.sort((a, b) => a.time - b.time);

            let nextTime = allTimes.find(t => t.time > currentTime);
            if (!nextTime) {
                nextTime = allTimes[0];
                nextTime.time += 1440; // –ü–µ—Ä–≤—ã–π —Ä–µ–π—Å —Å–ª–µ–¥—É—é—â–µ–≥–æ –¥–Ω—è
                nextBus.status = "üî¥ –û—Ñ—Ñ–ª–∞–π–Ω"; // –°—Ç–∞—Ç—É—Å "–û—Ñ—Ñ–ª–∞–π–Ω" –¥–ª—è –ø–µ—Ä–≤–æ–≥–æ —Ä–µ–π—Å–∞ —Å–ª–µ–¥—É—é—â–µ–≥–æ –¥–Ω—è
            } else {
                nextBus.status = "üü° –í –ø—É—Ç–∏"; // –°—Ç–∞—Ç—É—Å "–í –ø—É—Ç–∏" –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ —Ä–µ–π—Å–∞
            }

            let remainingTime = nextTime.time - currentTime;
            if (remainingTime < 0) remainingTime += 1440;

            let formattedTime = formatTimeFromMinutes(nextTime.time % 1440);

            // –ü—Ä–æ–≤–µ—Ä–∫–∞, –µ—Å–ª–∏ —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –º–∏–Ω—É—Ç—ã –æ—Ç –≤—Ä–µ–º–µ–Ω–∏ –ø—Ä–∏–±—ã—Ç–∏—è
            for (let stop in stops) {
                let times = stops[stop].map(time => {
                    let [hours, minutes] = time.split(":").map(Number);
                    return hours * 60 + minutes;
                });
                for (let time of times) {
                    if (currentTime >= time && currentTime < time + 1) {
                        nextBus.status = "üü¢ –ü—Ä–∏–±—ã–≤–∞–µ—Ç";
                        remainingTime = 0;
                        formattedTime = formatTimeFromMinutes(time);
                        nextBus.stop = stop;
                        break;
                    }
                }
            }

            nextBus.time = formattedTime;
            nextBus.stop = nextTime.stop;
            nextBus.remaining = remainingTime;

            return nextBus;
        }
        
        function formatTimeFromMinutes(minutes) {
            let hours = Math.floor(minutes / 60);
            let mins = Math.floor(minutes % 60);
            return `${String(hours).padStart(2, '0')}:${String(mins).padStart(2, '0')}`;
        }
        
        function closeBusWindow(busNumber) {
            document.getElementById(`bus-window-${busNumber}`).style.display = 'none';
            document.getElementById(`bus-window-${busNumber}`).innerHTML = '';
        }
        
        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏
        function showMap(stopName) {
            alert(`–ö–∞—Ä—Ç–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ "${stopName}" –±—É–¥–µ—Ç –ø–æ–∫–∞–∑–∞–Ω–∞ –∑–¥–µ—Å—å.`);
        }
        
        function showStopSchedule(stopName) {
            alert(`–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ "${stopName}" –±—É–¥–µ—Ç –ø–æ–∫–∞–∑–∞–Ω–æ –∑–¥–µ—Å—å.`);
        }
        
        function addToFavorites(stopName) {
            alert(`–û—Å—Ç–∞–Ω–æ–≤–∫–∞ "${stopName}" –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ.`);
        }
        
        function showRouteFromStop(stopName) {
            alert(`–ú–∞—Ä—à—Ä—É—Ç—ã —á–µ—Ä–µ–∑ –æ—Å—Ç–∞–Ω–æ–≤–∫—É "${stopName}" –±—É–¥—É—Ç –ø–æ–∫–∞–∑–∞–Ω—ã –∑–¥–µ—Å—å.`);
        }
        
        // –°–º–µ–Ω–∞ —Ä–µ–∂–∏–º–∞
        function switchMode() {
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –æ—Ç–∫—Ä—ã—Ç—ã–µ –æ–∫–Ω–∞
            document.querySelectorAll('.bus-window').forEach(window => {
                window.style.display = 'none';
                window.innerHTML = '';
            });
            stopInfoWindow.style.display = 'none';
            mapContainer.style.display = 'none';
            stopsListContainer.classList.add('hidden');
            
            // –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –Ω–∞ –≥–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω
            appContainer.classList.add('hidden');
            modeSwitchBtn.classList.add('hidden');
            welcomeScreen.style.display = 'block';
            adminLogin.style.display = 'none';
            adminModeBtn.style.display = 'block';
            userModeBtn.style.display = 'block';
            errorMsg.style.display = 'none';
            adminPassword.value = '';
            
            // –û—á–∏—â–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (–±–µ–∑ —É–¥–∞–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö)
            localStorage.setItem('appState', 'inactive');
        }
    </script>
</body>
</html>
