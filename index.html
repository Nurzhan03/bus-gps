<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>Bus Tracker (OpenStreetMap)</title>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    #map { width: 100%; height: 500px; margin-top: 20px; }
    input, button { padding: 8px; font-size: 16px; margin-right: 10px; }

    .vehicle-marker {
      position: relative;
      width: 90px;
      height: 25px;
      display: flex;
      align-items: center;
      gap: 0px;
      user-select: none;
    }
    .vehicle-drop {
      position: relative;
      width: 25px;
      height: 25px;
      margin-right: 3px;
    }
    .vehicle-drop img {
      position: absolute;
      top: 0; left: 0;
      width: 25px;
      height: 25px;
    }
    .vehicle-drop img:nth-child(2) {
      left: -2px;
      top: -1px;
    }
    .vehicle-marker__text {
      display: flex;
      background: #fff;
      padding: 0 6px;
      font-weight: bold;
      font-size: 16px;
      color: black;
      align-items: center;
      height: 25px;
      line-height: 25px;
    }

    #loginPanel, #controlPanel {
      margin-bottom: 10px;
    }
  </style>
</head>
<body>

<h2>GPS Трекинг автобусов (OpenStreetMap)</h2>

<!-- Экран входа по PIN -->
<div id="loginPanel">
  <input type="password" id="pinInput" placeholder="Введите PIN-код" />
  <button id="loginBtn">Войти</button>
</div>

<!-- Панель управления для водителя -->
<div id="controlPanel" style="display:none;">
  <input type="text" id="busNumber" placeholder="Номер маршрута" />
  <button id="shiftButton">Начать смену</button>
  <button id="logoutBtn" style="margin-left:10px;">Выйти</button>
</div>

<div id="map" style="display:none;"></div>

<script>
  // Firebase init
  const firebaseConfig = {
    apiKey: "AIzaSyBc-x0sFbt16lzmMx77dLwysXGJUOsXKsY",
    authDomain: "bustrackerweb.firebaseapp.com",
    projectId: "bustrackerweb",
    storageBucket: "bustrackerweb.appspot.com",
    messagingSenderId: "325393024111",
    appId: "1:325393024111:web:d78728eb97180a03aeb99a",
    measurementId: "G-TRVJFYPJXZ",
    databaseURL: "https://bustrackerweb-default-rtdb.europe-west1.firebasedatabase.app"
  };

  firebase.initializeApp(firebaseConfig);
  const database = firebase.database();

  let currentDriver = null;
  let watchId = null;
  let map = null;
  let busMarkers = {};

  const loginPanel = document.getElementById("loginPanel");
  const controlPanel = document.getElementById("controlPanel");
  const mapDiv = document.getElementById("map");
  const pinInput = document.getElementById("pinInput");
  const loginBtn = document.getElementById("loginBtn");
  const logoutBtn = document.getElementById("logoutBtn");
  const busNumberInput = document.getElementById("busNumber");
  const shiftButton = document.getElementById("shiftButton");

  // Создание маркера с номером маршрута
  function createBusMarker(busNumber) {
    const html = `
      <div class="vehicle-marker">
        <div class="vehicle-drop">
          <img src="https://oskemenbus.kz/assets/images/map-icons/vehicle-icons/background/bus.svg" alt="background">
          <img src="https://oskemenbus.kz/assets/images/map-icons/vehicle-icons/icon/bus.svg" alt="icon">
        </div>
        <div class="vehicle-marker__text">
          <span>${busNumber || ''}</span>
        </div>
      </div>
    `;
    return L.divIcon({
      html: html,
      className: "",
      iconSize: [90, 25],
      iconAnchor: [45, 12],
      popupAnchor: [0, -25]
    });
  }

  // Обновление карты и маркеров из Firebase
  function updateMap() {
    database.ref("drivers").once("value", snapshot => {
      // Удаляем старые маркеры
      for (let key in busMarkers) {
        map.removeLayer(busMarkers[key]);
      }
      busMarkers = {};

      snapshot.forEach(childSnapshot => {
        const driver = childSnapshot.val();
        if (driver.latitude && driver.longitude) {
          const marker = L.marker([driver.latitude, driver.longitude], {
            icon: createBusMarker(driver.route)
          }).addTo(map).bindPopup(
            `Маршрут: ${driver.route || "не указан"}<br>Время: ${driver.timestamp || "—"}`
          );
          busMarkers[childSnapshot.key] = marker;
        }
      });
    });
  }

  // Начать отслеживание геопозиции и обновлять данные в Firebase
  function startTracking(driverId) {
    if (navigator.geolocation) {
      watchId = navigator.geolocation.watchPosition(pos => {
        const lat = pos.coords.latitude;
        const lon = pos.coords.longitude;
        const route = busNumberInput.value.trim() || null;

        database.ref("drivers/" + driverId).update({
          latitude: lat,
          longitude: lon,
          timestamp: new Date().toISOString(),
          route: route
        });
      }, error => {
        alert("Ошибка геолокации: " + error.message);
      });
    } else {
      alert("Геолокация не поддерживается этим устройством");
    }
  }

  // Остановить отслеживание
  function stopTracking() {
    if (watchId !== null) {
      navigator.geolocation.clearWatch(watchId);
      watchId = null;
    }
    if (currentDriver) {
      database.ref("drivers/" + currentDriver).update({
        latitude: null,
        longitude: null,
        timestamp: null
      });
      currentDriver = null;
    }
    busNumberInput.value = "";
  }

  // Переключение состояния смены
  function toggleShift() {
    if (watchId) {
      stopTracking();
      shiftButton.textContent = "Начать смену";
    } else {
      startTracking(currentDriver);
      shiftButton.textContent = "Завершить смену";
    }
  }

  // Обработчик логина по PIN
  loginBtn.addEventListener("click", () => {
    const pin = pinInput.value.trim();
    if (!pin) {
      alert("Введите PIN-код");
      return;
    }

    database.ref("drivers").orderByChild("pin").equalTo(pin).once("value", snapshot => {
      if (snapshot.exists()) {
        snapshot.forEach(childSnapshot => {
          currentDriver = childSnapshot.key;
          const driverData = childSnapshot.val();

          // Скрыть экран входа, показать управление и карту
          loginPanel.style.display = "none";
          controlPanel.style.display = "block";
          mapDiv.style.display = "block";

          busNumberInput.value = driverData.route || "";

          // Инициализация карты, если еще не инициализирована
          if (!map) {
            map = L.map('map').setView([49.9567, 82.6075], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
              attribution: '&copy; OpenStreetMap'
            }).addTo(map);

            // Обновление карты при изменениях в базе
            database.ref("drivers").on("value", updateMap);
          }

          updateMap();

          shiftButton.textContent = "Начать смену";
          pinInput.value = "";
        });
      } else {
        alert("Неверный PIN-код");
      }
    });
  });

  // Кнопка выхода — сбрасываем всё и возвращаемся к экрану входа
  logoutBtn.addEventListener("click", () => {
    stopTracking();
    currentDriver = null;
    loginPanel.style.display = "block";
    controlPanel.style.display = "none";
    mapDiv.style.display = "none";
    pinInput.value = "";
  });

  shiftButton.addEventListener("click", toggleShift);

  // Перед уходом со страницы остановить трекинг
  window.addEventListener("beforeunload", () => {
    stopTracking();
  });
</script>

</body>
</html>
