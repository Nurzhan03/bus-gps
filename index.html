<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Bus Tracker</title>

  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      width: 100%;
      font-family: Arial, sans-serif;
    }

    h2 {
      text-align: center;
      margin: 16px 0;
    }

    #map {
      width: 100%;
      height: calc(100% - 140px); /* –ø–æ–¥—Å—Ç—Ä–∞–∏–≤–∞–π –ø–æ–¥ –≤—ã—Å–æ—Ç—É –¥—Ä—É–≥–∏—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –≤—ã—à–µ –∫–∞—Ä—Ç—ã */
      margin: 0;
    }

    input, button {
      padding: 10px;
      font-size: 16px;
      margin: 5px 0;
      width: 100%;
      box-sizing: border-box;
    }

    .vehicle-marker {
      position: relative;
      display: flex;
      align-items: center;
      user-select: none;
    }

    .vehicle-drop {
      position: relative;
      width: 25px;
      height: 25px;
      margin-right: 3px;
    }

    .vehicle-drop img {
      position: absolute;
      top: 0;
      left: 0;
      width: 25px;
      height: 25px;
    }

    .vehicle-drop img:nth-child(2) {
      left: -2px;
      top: -1px;
    }

    .vehicle-marker__text {
      display: flex;
      background: #fff;
      padding: 0 6px;
      font-weight: bold;
      font-size: 16px;
      color: black;
      align-items: center;
      height: 25px;
      line-height: 25px;
    }

    #driverPanel {
      display: none;
    }

    @media (max-width: 600px) {
      h2 {
        font-size: 20px;
        margin: 12px 0;
      }

      input, button {
        font-size: 15px;
        padding: 12px;
      }

      .vehicle-marker__text {
        font-size: 14px;
        padding: 0 5px;
        height: 22px;
        line-height: 22px;
      }

      .vehicle-drop {
        width: 22px;
        height: 22px;
        margin-right: 2px;
      }

      .vehicle-drop img {
        width: 22px;
        height: 22px;
      }

      #map {
        height: calc(100% - 130px);
      }
    }
  </style>
</head>
<body>

<h2>Bus Tracker</h2>

<div id="loginPanel">
  <input type="password" id="pinInput" placeholder="–í–≤–µ–¥–∏—Ç–µ PIN" />
  <button onclick="login()">–í–æ–π—Ç–∏</button>
</div>

<div id="driverPanel">
  <input type="text" id="routeInput" placeholder="–ù–æ–º–µ—Ä –º–∞—Ä—à—Ä—É—Ç–∞" />
  <button id="startStopBtn" onclick="toggleTracking()">–ù–∞—á–∞—Ç—å —Å–º–µ–Ω—É</button>
  <button id="changeRouteBtn" onclick="changeRoute()">–ü–æ–º–µ–Ω—è—Ç—å –º–∞—Ä—à—Ä—É—Ç</button>
</div>

<div id="map"></div>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyBc-x0sFbt16lzmMx77dLwysXGJUOsXKsY",
    authDomain: "bustrackerweb.firebaseapp.com",
    projectId: "bustrackerweb",
    storageBucket: "bustrackerweb.appspot.com",
    messagingSenderId: "325393024111",
    appId: "1:325393024111:web:d78728eb97180a03aeb99a",
    measurementId: "G-TRVJFYPJXZ",
    databaseURL: "https://bustrackerweb-default-rtdb.europe-west1.firebasedatabase.app"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  let currentDriver = null;
  let watchId = null;
  let prevPosition = null;
  const busMarkers = {};

  const map = L.map('map').setView([49.9693, 82.6026], 20);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap'
  }).addTo(map);

  function calculateAngle(p1, p2) {
    const lat1 = p1.lat * Math.PI / 180;
    const lat2 = p2.lat * Math.PI / 180;
    const dLon = (p2.lng - p1.lng) * Math.PI / 180;

    const y = Math.sin(dLon) * Math.cos(lat2);
    const x = Math.cos(lat1) * Math.sin(lat2) - Math.sin(lat1) * Math.cos(lat2) * Math.cos(dLon);
    let brng = Math.atan2(y, x) * 180 / Math.PI;

    return (brng + 360) % 360;
  }

  function createBusMarker(route, angle = 0) {
    const html = `
      <div class="vehicle-marker">
        <div class="vehicle-drop">
          <img src="https://oskemenbus.kz/assets/images/map-icons/vehicle-icons/background/bus.svg" alt="bg" style="transform: rotate(${(angle + 180) % 360}deg); transition: transform 0.5s;">
          <img src="https://oskemenbus.kz/assets/images/map-icons/vehicle-icons/icon/bus.svg" alt="icon">
        </div>
        <div class="vehicle-marker__text">
          <span>${route ?? ''}</span>
        </div>
      </div>
    `;
    return L.divIcon({
      html,
      className: "",
      iconSize: [90, 25],
      iconAnchor: [45, 12]
    });
  }

  function login() {
    const pin = document.getElementById("pinInput").value;
    db.ref("drivers").orderByChild("pin").equalTo(pin).once("value", snap => {
      if (snap.exists()) {
        const driverId = Object.keys(snap.val())[0];
        currentDriver = driverId;
        const driverData = snap.val()[driverId];

        document.getElementById("loginPanel").style.display = "none";
        document.getElementById("driverPanel").style.display = "block";

        document.getElementById("routeInput").value = driverData.route ?? "";
        const changeBtn = document.querySelector('button[onclick="changeRoute()"]');
        if (driverData.route) changeBtn.style.display = "inline-block";
        else changeBtn.style.display = "none";

        if (driverData.latitude && driverData.longitude) {
          document.getElementById("startStopBtn").innerText = "–ó–∞–≤–µ—Ä—à–∏—Ç—å —Å–º–µ–Ω—É";

          if (!navigator.geolocation) return alert("–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è");
          prevPosition = L.latLng(driverData.latitude, driverData.longitude);

          startTracking();
        } else {
          document.getElementById("startStopBtn").innerText = "–ù–∞—á–∞—Ç—å —Å–º–µ–Ω—É";
        }
      } else {
        alert("–ù–µ–≤–µ—Ä–Ω—ã–π PIN");
      }
    });
  }

  function startTracking() {
    watchId = navigator.geolocation.watchPosition(pos => {
      const currPos = L.latLng(pos.coords.latitude, pos.coords.longitude);
      const route = document.getElementById("routeInput").value;

      const distanceMoved = prevPosition ? currPos.distanceTo(prevPosition) : Infinity;
      if (distanceMoved < 1) return; // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –º–µ–ª–∫–∏–µ —Å–∫–∞—á–∫–∏ < 1 –º–µ—Ç—Ä–∞

      let angle = 0;
      if (prevPosition) {
        angle = calculateAngle(prevPosition, currPos);
      }
      prevPosition = currPos;

      db.ref("drivers/" + currentDriver).update({
        latitude: currPos.lat,
        longitude: currPos.lng,
        timestamp: new Date().toISOString(),
        route,
        angle
      });

      map.panTo(currPos, { animate: true, duration: 0.5 });

    }, err => {
      alert("–û—à–∏–±–∫–∞ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏: " + err.message);
    }, {
      enableHighAccuracy: true,
      maximumAge: 1000
    });
  }

  function toggleTracking() {
    const btn = document.getElementById("startStopBtn");

    if (btn.innerText === "–ù–∞—á–∞—Ç—å —Å–º–µ–Ω—É") {
      if (!navigator.geolocation) return alert("–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è");
      startTracking();
      btn.innerText = "–ó–∞–≤–µ—Ä—à–∏—Ç—å —Å–º–µ–Ω—É";
      document.getElementById("changeRouteBtn").style.display = "inline-block";
    } else {
      if (watchId !== null) {
        navigator.geolocation.clearWatch(watchId);
        watchId = null;
      }

      db.ref("drivers/" + currentDriver).update({
        latitude: null,
        longitude: null,
        timestamp: null,
        route: null,
        angle: null
      });

      prevPosition = null;
      document.getElementById("routeInput").value = "";
      document.querySelector('button[onclick="changeRoute()"]').style.display = "none";
      btn.innerText = "–ù–∞—á–∞—Ç—å —Å–º–µ–Ω—É";
      document.getElementById("changeRouteBtn").style.display = "none";

      if (busMarkers[currentDriver]) {
        map.removeLayer(busMarkers[currentDriver]);
        delete busMarkers[currentDriver];
      }
    }
  }

  function changeRoute() {
    const route = document.getElementById("routeInput").value;
    db.ref("drivers/" + currentDriver).update({ route });
  }

  function updateMarkers() {
    db.ref("drivers").once("value", snap => {
      const existingKeys = new Set();
  
      snap.forEach(child => {
        const key = child.key;
        const data = child.val();
  
        if (data.latitude && data.longitude) {
          const latlng = L.latLng(data.latitude, data.longitude);
          const angle = data.angle ?? 0;
  
          if (busMarkers[key]) {
            // üü° –û–±–Ω–æ–≤–∏—Ç—å –ø–æ–∑–∏—Ü–∏—é –∏ –∏–∫–æ–Ω–∫—É –ø–ª–∞–≤–Ω–æ
            busMarkers[key].setLatLng(latlng);
  
            const icon = createBusMarker(data.route, angle);
            busMarkers[key].setIcon(icon);
          } else {
            // üü¢ –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –º–∞—Ä–∫–µ—Ä
            const marker = L.marker(latlng, {
              icon: createBusMarker(data.route, angle)
            }).addTo(map);
  
            marker.bindPopup("–í–æ–¥–∏—Ç–µ–ª—å: " + key + "<br>–ú–∞—Ä—à—Ä—É—Ç: " + (data.route ?? "‚Äî"));
            busMarkers[key] = marker;
          }
  
          existingKeys.add(key);
        }
      });
  
      // üî¥ –£–¥–∞–ª—è–µ–º –º–∞—Ä–∫–µ—Ä—ã, –∫–æ—Ç–æ—Ä—ã—Ö –±–æ–ª—å—à–µ –Ω–µ—Ç –≤ –±–∞–∑–µ
      for (let key in busMarkers) {
        if (!existingKeys.has(key)) {
          map.removeLayer(busMarkers[key]);
          delete busMarkers[key];
        }
      }
    });
  }

  db.ref("drivers").on("value", updateMarkers);
  updateMarkers();
</script>

</body>
</html>
