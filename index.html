<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bus Tracker</title>
  <script src="https://cdn.jsdelivr.net/npm/socket.io-client@4.3.2/dist/socket.io.min.js"></script>
  <script src="https://api-maps.yandex.ru/2.1/?lang=ru_RU" type="text/javascript"></script>
  <script src="script.js" defer></script>
  <style>
    /* Базовая стилизация */
    body {
      font-family: Arial, sans-serif;
      padding: 10px;
      margin: 0;
      background-color: #f5f5f5;
    }

    input, button {
      padding: 12px;
      font-size: 16px;
      width: 100%;
      margin-bottom: 10px;
      box-sizing: border-box;
      border: 1px solid #ccc;
      border-radius: 6px;
    }

    /* Карта */
    #map {
      width: 100%;
      height: 80vh;
      margin-top: 10px;
    }

    /* Панель водителя */
    #driverPanel {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 10px;
    }

    /* Стили для маркеров */
    .vehicle-marker {
      display: flex;
      align-items: center;
      background-color: #007bff;
      color: white;
      padding: 4px 8px;
      border-radius: 8px;
      font-weight: bold;
      white-space: nowrap;
    }

    .vehicle-marker__text {
      font-size: 14px;
    }

    .vehicle-drop {
      width: 24px;
      height: 24px;
      margin-left: 6px;
    }

    .vehicle-drop img {
      width: 100%;
      height: 100%;
    }

    /* Мобильная адаптация */
    @media (max-width: 600px) {
      .vehicle-marker {
        width: auto;
        height: auto;
        padding: 2px 6px;
      }

      .vehicle-marker__text {
        font-size: 12px;
      }

      .vehicle-drop {
        width: 20px;
        height: 20px;
      }

      .vehicle-drop img {
        width: 20px;
        height: 20px;
      }

      input, button {
        font-size: 15px;
      }
    }
  </style>
</head>
<body>

<h2>Bus Tracker</h2>

<div id="loginPanel">
  <input type="password" id="pinInput" placeholder="Введите PIN" />
  <button onclick="login()">Войти</button>
</div>

<div id="driverPanel">
  <input type="text" id="routeInput" placeholder="Номер маршрута" />
  <button id="startStopBtn" onclick="toggleTracking()">Начать смену</button>
  <button id="changeRouteBtn" onclick="changeRoute()">Поменять маршрут</button>
</div>

<div id="map"></div>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyBc-x0sFbt16lzmMx77dLwysXGJUOsXKsY",
    authDomain: "bustrackerweb.firebaseapp.com",
    projectId: "bustrackerweb",
    storageBucket: "bustrackerweb.appspot.com",
    messagingSenderId: "325393024111",
    appId: "1:325393024111:web:d78728eb97180a03aeb99a",
    measurementId: "G-TRVJFYPJXZ",
    databaseURL: "https://bustrackerweb-default-rtdb.europe-west1.firebasedatabase.app"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  let currentDriver = null;
  let watchId = null;
  let prevPosition = null;
  const busMarkers = {};

  const map = L.map('map').setView([49.9693, 82.6026], 16);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap'
  }).addTo(map);

  // Координаты дороги (пример с двумя точками)
  const roadCoords = [
    [49.969931, 82.603020],
    [49.968737, 82.602285]
  ];

  // Создаем линию, но не добавляем на карту (не видна)
  const roadLine = L.polyline(roadCoords);

  // Функция для поиска ближайшей точки на линии к позиции (latLng)
  function getClosestPointOnLine(latlng, line) {
    let minDist = Infinity;
    let closestPoint = null;
    let closestSegmentIndex = 0;

    // Перебираем сегменты линии
    const points = line.getLatLngs();
    for (let i = 0; i < points.length - 1; i++) {
      const p1 = points[i];
      const p2 = points[i + 1];

      // Найдем проекцию точки на отрезок p1-p2
      const projected = projectPointOnSegment(latlng, p1, p2);

      // Вычисляем дистанцию между latlng и проекцией
      const dist = latlng.distanceTo(projected);

      if (dist < minDist) {
        minDist = dist;
        closestPoint = projected;
        closestSegmentIndex = i;
      }
    }
    return { point: closestPoint, segmentIndex: closestSegmentIndex };
  }

  // Проекция точки на отрезок p1-p2
  function projectPointOnSegment(p, p1, p2) {
    // Конвертируем в векторные координаты (в метрах) для удобства
    const toMeters = (latlng) => {
      return map.latLngToLayerPoint(latlng);
    };

    const fromMeters = (point) => {
      return map.layerPointToLatLng(point);
    };

    const pM = toMeters(p);
    const p1M = toMeters(p1);
    const p2M = toMeters(p2);

    const dx = p2M.x - p1M.x;
    const dy = p2M.y - p1M.y;

    if (dx === 0 && dy === 0) return p1;

    const t = ((pM.x - p1M.x) * dx + (pM.y - p1M.y) * dy) / (dx * dx + dy * dy);

    let tClamped = Math.max(0, Math.min(1, t));

    const projX = p1M.x + tClamped * dx;
    const projY = p1M.y + tClamped * dy;

    return fromMeters(L.point(projX, projY));
  }

  // Вычисление угла между двумя точками в градусах (для поворота маркера)
  function calculateAngle(p1, p2) {
    const lat1 = p1.lat * Math.PI / 180;
    const lat2 = p2.lat * Math.PI / 180;
    const dLon = (p2.lng - p1.lng) * Math.PI / 180;

    const y = Math.sin(dLon) * Math.cos(lat2);
    const x = Math.cos(lat1) * Math.sin(lat2) -
              Math.sin(lat1) * Math.cos(lat2) * Math.cos(dLon);
    let brng = Math.atan2(y, x) * 180 / Math.PI;

    return (brng + 360) % 360;
  }

  function createBusMarker(route, angle = 0) {
    const html = `
      <div class="vehicle-marker">
        <div class="vehicle-drop">
          <img src="https://oskemenbus.kz/assets/images/map-icons/vehicle-icons/background/bus.svg" alt="bg" style="transform: rotate(${(angle + 180) % 360}deg); transition: transform 0.5s;">
          <img src="https://oskemenbus.kz/assets/images/map-icons/vehicle-icons/icon/bus.svg" alt="icon">
        </div>
        <div class="vehicle-marker__text">
          <span>${route ?? ''}</span>
        </div>
      </div>
    `;
    return L.divIcon({
      html,
      className: "",
      iconSize: [90, 25],
      iconAnchor: [45, 12]
    });
  }

  function login() {
    const pin = document.getElementById("pinInput").value;
    db.ref("drivers").orderByChild("pin").equalTo(pin).once("value", snap => {
      if (snap.exists()) {
        const driverId = Object.keys(snap.val())[0];
        currentDriver = driverId;
        const driverData = snap.val()[driverId];

        document.getElementById("loginPanel").style.display = "none";
        document.getElementById("driverPanel").style.display = "block";

        document.getElementById("routeInput").value = driverData.route ?? "";
        const changeBtn = document.querySelector('button[onclick="changeRoute()"]');
        if (driverData.route) {
          changeBtn.style.display = "inline-block";
        } else {
          changeBtn.style.display = "none";
        }

        if (driverData.latitude && driverData.longitude) {
          document.getElementById("startStopBtn").innerText = "Завершить смену";

          if (!navigator.geolocation) return alert("Геолокация не поддерживается");
          prevPosition = L.latLng(driverData.latitude, driverData.longitude);

          watchId = navigator.geolocation.watchPosition(pos => {
            const currPos = L.latLng(pos.coords.latitude, pos.coords.longitude);
            const route = document.getElementById("routeInput").value;

            // Привязываем текущую позицию к дороге
            const { point: snappedPoint, segmentIndex } = getClosestPointOnLine(currPos, roadLine);

            let angle = 0;
            if (prevPosition) {
              // Для вычисления угла берем текущую "привязанную" точку и следующую точку дороги
              const nextPointIndex = Math.min(segmentIndex + 1, roadCoords.length - 1);
              const nextPoint = L.latLng(roadCoords[nextPointIndex][0], roadCoords[nextPointIndex][1]);
              angle = calculateAngle(snappedPoint, nextPoint);
            }
            prevPosition = snappedPoint;

            db.ref("drivers/" + currentDriver).update({
              latitude: snappedPoint.lat,
              longitude: snappedPoint.lng,
              timestamp: new Date().toISOString(),
              route,
              angle
            });
          }, err => {
            alert("Ошибка геолокации: " + err.message);
          });
        } else {
          document.getElementById("startStopBtn").innerText = "Начать смену";
        }
      } else {
        alert("Неверный PIN");
      }
    });
  }

  function toggleTracking() {
    const btn = document.getElementById("startStopBtn");

    if (btn.innerText === "Начать смену") {
      if (!navigator.geolocation) return alert("Геолокация не поддерживается");

      watchId = navigator.geolocation.watchPosition(pos => {
        const currPos = L.latLng(pos.coords.latitude, pos.coords.longitude);
        const route = document.getElementById("routeInput").value;

        const { point: snappedPoint, segmentIndex } = getClosestPointOnLine(currPos, roadLine);

        let angle = 0;
        if (prevPosition) {
          const nextPointIndex = Math.min(segmentIndex + 1, roadCoords.length - 1);
          const nextPoint = L.latLng(roadCoords[nextPointIndex][0], roadCoords[nextPointIndex][1]);
          angle = calculateAngle(snappedPoint, nextPoint);
        }
        prevPosition = snappedPoint;

        db.ref("drivers/" + currentDriver).update({
          latitude: snappedPoint.lat,
          longitude: snappedPoint.lng,
          timestamp: new Date().toISOString(),
          route,
          angle
        });

        if (route) {
          document.querySelector('button[onclick="changeRoute()"]').style.display = "inline-block";
        }
      }, err => {
        alert("Ошибка геолокации: " + err.message);
      });

      btn.innerText = "Завершить смену";
      document.getElementById("changeRouteBtn").style.display = "inline-block";

    } else {
      if (watchId !== null) {
        navigator.geolocation.clearWatch(watchId);
        watchId = null;
      }
      db.ref("drivers/" + currentDriver).update({
        latitude: null,
        longitude: null,
        timestamp: null,
        route: null,
        angle: null
      });

      prevPosition = null;

      document.getElementById("routeInput").value = "";
      document.querySelector('button[onclick="changeRoute()"]').style.display = "none";
      btn.innerText = "Начать смену";
      document.getElementById("changeRouteBtn").style.display = "none";

      if (busMarkers[currentDriver]) {
        map.removeLayer(busMarkers[currentDriver]);
        delete busMarkers[currentDriver];
      }
    }
  }

  function changeRoute() {
    const route = document.getElementById("routeInput").value;
    db.ref("drivers/" + currentDriver).update({ route });
  }

  function updateMarkers() {
    db.ref("drivers").once("value", snap => {
      for (let id in busMarkers) {
        map.removeLayer(busMarkers[id]);
      }
      Object.keys(busMarkers).forEach(key => delete busMarkers[key]);

      snap.forEach(child => {
        const key = child.key;
        const data = child.val();
        if (data.latitude && data.longitude) {
          const marker = L.marker([data.latitude, data.longitude], {
            icon: createBusMarker(data.route, data.angle ?? 0)
          }).addTo(map);
          marker.bindPopup("Водитель: " + key + "<br>Маршрут: " + (data.route ?? "—"));
          busMarkers[key] = marker;
        }
      });
    });
  }

  db.ref("drivers").on("value", updateMarkers);
  updateMarkers();
</script>

</body>
</html>
