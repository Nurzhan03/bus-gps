<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Bus Tracker (OpenStreetMap)</title>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    #map { width: 100%; height: 500px; margin-top: 20px; }
    body { font-family: Arial, sans-serif; padding: 20px; }
    input, button { padding: 8px; font-size: 16px; margin-right: 10px; }
  </style>
</head>
<body>
<button onclick="checkLocation()">Проверить координаты</button>
<script>
function checkLocation() {
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(
      (position) => {
        alert("Широта: " + position.coords.latitude + ", Долгота: " + position.coords.longitude);
      },
      (error) => {
        alert("Ошибка: " + error.message);
      }
    );
  } else {
    alert("Геолокация не поддерживается");
  }
}
</script>

  <h2>GPS Трекинг автобусов (OpenStreetMap)</h2>

  <input type="text" id="busNumber" placeholder="Номер автобуса">
  <button onclick="startTracking(document.getElementById('busNumber').value)">Начать смену</button>

  <div id="map"></div>

  <script>
    // Инициализация Firebase
const firebaseConfig = {
  apiKey: "AIzaSyBc-x0sFbt16lzmMx77dLwysXGJUOsXKsY",
  authDomain: "bustrackerweb.firebaseapp.com",
  projectId: "bustrackerweb",
  storageBucket: "bustrackerweb.firebasestorage.app",
  messagingSenderId: "325393024111",
  appId: "1:325393024111:web:d78728eb97180a03aeb99a",
  measurementId: "G-TRVJFYPJXZ"
};
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    
    // Функция начала смены (GPS-трекинг)
    function startTracking(busNumber) {
      if (!busNumber) {
        alert("Введите номер автобуса");
        return;
      }
      if (navigator.geolocation) {
        navigator.geolocation.watchPosition(function(position) {
          const lat = position.coords.latitude;
          const lon = position.coords.longitude;
          firebase.database().ref('buses/' + busNumber).set({
            latitude: lat,
            longitude: lon,
            timestamp: new Date().toISOString()
          });
        }, function(error) {
          alert("Ошибка получения координат: " + error.message);
        });
      } else {
        alert("Геолокация не поддерживается этим устройством");
      }
    }

    // Инициализация карты
    let map = L.map('map').setView([49.9567, 82.6075], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap'
    }).addTo(map);

    let busMarkers = {};

    function updateMarkers() {
      firebase.database().ref('buses').once('value', function(snapshot) {
        // Удаляем старые маркеры
        for (let key in busMarkers) {
          map.removeLayer(busMarkers[key]);
        }
        busMarkers = {};

        // Добавляем новые маркеры
        snapshot.forEach(function(childSnapshot) {
          let bus = childSnapshot.val();
          let marker = L.marker([bus.latitude, bus.longitude])
            .addTo(map)
            .bindPopup("Автобус № " + childSnapshot.key + "<br>Время: " + bus.timestamp);
          busMarkers[childSnapshot.key] = marker;
        });
      });
    }

    // Обновление маркеров каждые 5 секунд
    setInterval(updateMarkers, 5000);

  </script>

</body>
</html>
