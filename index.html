<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Вход водителя</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    html, body {
      height: 100%;
      margin: 0;
    }
    #map {
      height: 100%;
      width: 100%;
    }
    #loginPanel, #driverPanel {
      position: absolute;
      top: 10px;
      left: 10px;
      background: white;
      padding: 10px;
      z-index: 999;
      box-shadow: 0 0 10px rgba(0,0,0,0.2);
      border-radius: 8px;
    }
    #driverPanel {
      display: none;
    }
    .vehicle-marker {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .vehicle-drop {
      position: relative;
    }
    .vehicle-drop img:first-child {
      position: absolute;
      top: 0;
      left: 0;
    }
    .vehicle-drop img:last-child {
      position: relative;
    }
    .vehicle-marker__text span {
      font-weight: bold;
      background: #fff;
      padding: 2px 6px;
      border-radius: 4px;
      margin-top: 5px;
    }
  </style>
</head>
<body>

<div id="map"></div>

<div id="loginPanel">
  <input type="text" id="pinInput" placeholder="Введите PIN">
  <button onclick="login()">Войти</button>
</div>

<div id="driverPanel">
  <div>
    <input type="text" id="routeInput" placeholder="Номер маршрута">
    <button onclick="changeRoute()">Поменять маршрут</button>
  </div>
  <div style="margin-top:10px;">
    <button id="startStopBtn" onclick="toggleTracking()">Начать смену</button>
  </div>
</div>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyBc-x0sFbt16lzmMx77dLwysXGJUOsXKsY",
    authDomain: "bustrackerweb.firebaseapp.com",
    projectId: "bustrackerweb",
    storageBucket: "bustrackerweb.appspot.com",
    messagingSenderId: "325393024111",
    appId: "1:325393024111:web:d78728eb97180a03aeb99a",
    measurementId: "G-TRVJFYPJXZ",
    databaseURL: "https://bustrackerweb-default-rtdb.europe-west1.firebasedatabase.app"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  let currentDriver = null;
  let watchId = null;
  const busMarkers = {};

  const map = L.map('map').setView([49.9567, 82.6075], 13);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap'
  }).addTo(map);

  function createBusMarker(route) {
    const html = `
      <div class="vehicle-marker">
        <div class="vehicle-drop">
          <img src="https://oskemenbus.kz/assets/images/map-icons/vehicle-icons/background/bus.svg" alt="bg">
          <img src="https://oskemenbus.kz/assets/images/map-icons/vehicle-icons/icon/bus.svg" alt="icon">
        </div>
        <div class="vehicle-marker__text">
          <span>${route ?? ''}</span>
        </div>
      </div>
    `;
    return L.divIcon({
      html,
      className: "",
      iconSize: [90, 25],
      iconAnchor: [45, 12]
    });
  }

  function login() {
    const pin = document.getElementById("pinInput").value;
    db.ref("drivers").orderByChild("pin").equalTo(pin).once("value", snap => {
      if (snap.exists()) {
        const driverId = Object.keys(snap.val())[0];
        currentDriver = driverId;
        const driverData = snap.val()[driverId];

        document.getElementById("loginPanel").style.display = "none";
        document.getElementById("driverPanel").style.display = "block";

        document.getElementById("routeInput").value = driverData.route ?? "";

        if (driverData.latitude && driverData.longitude) {
          document.getElementById("startStopBtn").innerText = "Завершить смену";
        } else {
          document.getElementById("startStopBtn").innerText = "Начать смену";
        }

      } else {
        alert("Неверный PIN");
      }
    });
  }

  function toggleTracking() {
    const btn = document.getElementById("startStopBtn");

    if (btn.innerText === "Начать смену") {
      if (!navigator.geolocation) return alert("Геолокация не поддерживается");
      watchId = navigator.geolocation.watchPosition(pos => {
        const { latitude, longitude } = pos.coords;
        const route = document.getElementById("routeInput").value;
        db.ref("drivers/" + currentDriver).update({
          latitude,
          longitude,
          timestamp: new Date().toISOString(),
          route
        });
      }, err => {
        alert("Ошибка геолокации: " + err.message);
      });
      btn.innerText = "Завершить смену";
    } else {
      if (watchId !== null) {
        navigator.geolocation.clearWatch(watchId);
        watchId = null;
      }
      db.ref("drivers/" + currentDriver).update({
        latitude: null,
        longitude: null,
        timestamp: null
      });
      btn.innerText = "Начать смену";

      if (busMarkers[currentDriver]) {
        map.removeLayer(busMarkers[currentDriver]);
        delete busMarkers[currentDriver];
      }
    }
  }

  function changeRoute() {
    const route = document.getElementById("routeInput").value;
    db.ref("drivers/" + currentDriver).update({ route });
  }

  function updateMarkers() {
    db.ref("drivers").once("value", snap => {
      for (let id in busMarkers) {
        map.removeLayer(busMarkers[id]);
      }
      Object.keys(busMarkers).forEach(key => delete busMarkers[key]);

      snap.forEach(child => {
        const id = child.key;
        const data = child.val();
        if (data.latitude && data.longitude) {
          const marker = L.marker([data.latitude, data.longitude], {
            icon: createBusMarker(data.route)
          }).addTo(map);
          marker.bindPopup("Водитель: " + id + "<br>Маршрут: " + (data.route ?? "—"));
          busMarkers[id] = marker;
        }
      });
    });
  }

  db.ref("drivers").on("value", updateMarkers);
  updateMarkers();
</script>

</body>
</html>
