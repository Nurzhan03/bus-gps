<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Bus Tracker (OpenStreetMap)</title>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    #map { width: 100%; height: 500px; margin-top: 20px; }
    body { font-family: Arial, sans-serif; padding: 20px; }
    input, button { padding: 8px; font-size: 16px; margin-right: 10px; }
    #busList { margin-top: 20px; }
  </style>
</head>
<body>

<h2>GPS Трекинг автобусов (OpenStreetMap)</h2>

<input type="text" id="busNumber" placeholder="Номер автобуса">
<button onclick="startTracking(document.getElementById('busNumber').value)">Начать смену</button>

<div id="map"></div>

<h3>Список автобусов:</h3>
<ul id="busList"></ul>

<script>
  // Инициализация Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyBc-x0sFbt16lzmMx77dLwysXGJUOsXKsY",
    authDomain: "bustrackerweb.firebaseapp.com",
    projectId: "bustrackerweb",
    storageBucket: "bustrackerweb.appspot.com",
    messagingSenderId: "325393024111",
    appId: "1:325393024111:web:d78728eb97180a03aeb99a",
    measurementId: "G-TRVJFYPJXZ",
    databaseURL: "https://bustrackerweb-default-rtdb.europe-west1.firebasedatabase.app"
  };

  firebase.initializeApp(firebaseConfig);
  const database = firebase.database();

  // Карта
  let map = L.map('map').setView([49.9567, 82.6075], 13);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap'
  }).addTo(map);

  let busMarkers = {};

  // Кастомная иконка автобуса
  let busIcon = L.icon({
    iconUrl: 'https://i.yapx.ru/ZGGPr.png',
    iconSize: [40, 40],
    iconAnchor: [20, 40],
    popupAnchor: [0, -40]
  });

  // GPS-трекинг
  function startTracking(busNumber) {
    if (!busNumber) {
      alert("Введите номер автобуса");
      return;
    }
    if (navigator.geolocation) {
      navigator.geolocation.watchPosition(function(position) {
        const lat = position.coords.latitude;
        const lon = position.coords.longitude;
        database.ref('buses/' + busNumber).set({
          latitude: lat,
          longitude: lon,
          timestamp: new Date().toISOString()
        });
      }, function(error) {
        alert("Ошибка получения координат: " + error.message);
      });
    } else {
      alert("Геолокация не поддерживается этим устройством");
    }
  }

  // Обновление маркеров и списка
  function updateMarkersAndList() {
    database.ref('buses').once('value', function(snapshot) {
      // Удаляем старые маркеры
      for (let key in busMarkers) {
        map.removeLayer(busMarkers[key]);
      }
      busMarkers = {};

      // Очищаем список
      const busList = document.getElementById('busList');
      busList.innerHTML = '';

      // Проходим по каждому автобусу
      snapshot.forEach(function(childSnapshot) {
        let bus = childSnapshot.val();

        // Добавляем маркер на карту
        let marker = L.marker([bus.latitude, bus.longitude], { icon: busIcon })
          .addTo(map)
          .bindPopup("Автобус № " + childSnapshot.key + "<br>Время: " + new Date(bus.timestamp).toLocaleTimeString());
        busMarkers[childSnapshot.key] = marker;

        // Добавляем автобус в список
        let li = document.createElement('li');
        li.textContent = `Автобус №${childSnapshot.key} — ${bus.latitude.toFixed(5)}, ${bus.longitude.toFixed(5)} — обновлён: ${new Date(bus.timestamp).toLocaleTimeString()}`;
        busList.appendChild(li);
      });
    });
  }

  updateMarkers();
  setInterval(updateMarkersAndList, 5000);
</script>

</body>
</html>
